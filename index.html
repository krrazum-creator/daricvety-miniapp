<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <!-- фикс iOS-зума + стабильный viewport -->
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>дарицветы.москва — доставка цветов</title>

  <!-- font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#FFFFFF;
      --text:#1C1C1E;
      --muted:#6B6B73;
      --card:#FFFFFF;
      --stroke:rgba(0,0,0,.08);

      --primary:#F6E7A1;
      --primaryActive:#F3E39A;

      --secondary:#f7d8dc;
      --secondaryActive:#f2c7ce;

      --radius:22px;

      /* фикс высоты под telegram webapp */
      --app-h: 100vh;
    }

    *{box-sizing:border-box}
    html, body{
      height:100%;
      margin:0;
      padding:0;
      overflow-x:hidden;
    }
    body{
      font-family:"Manrope",-apple-system,system-ui,"SF Pro Text","SF Pro Display",Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height:var(--app-h);
    }

    .wrap{max-width:980px;margin:0 auto;padding:20px 16px 120px}

    header{
      padding:10px 0 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{line-height:1.1}
    .brand .name{font-size:22px;font-weight:800;letter-spacing:.1px}
    .brand .tag{margin-top:6px;font-size:13px;color:var(--muted);font-weight:600}

    .pill{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      display:flex;align-items:center;gap:10px;
      align-self:center;
    }
    .pill button{
      border:none;background:transparent;color:var(--text);
      font-weight:800;font-size:13px;cursor:pointer;
      text-transform:lowercase;
    }
    .pill .count{
      min-width:22px;height:22px;border-radius:999px;
      background:var(--primary);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:12px;
      border:1px solid rgba(0,0,0,.06);
    }

    /* ===== FILTERS ===== */
    .filters{
      margin-top:6px;
      display:flex;
      gap:8px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding:6px 0 2px;
    }
    .chip{
      border:1px solid var(--stroke);
      background:#fff;
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      text-transform:lowercase;
      cursor:pointer;
      white-space:nowrap;
      color:var(--text);
    }
    .chip.on{
      background:var(--primary);
      border-color:rgba(0,0,0,.06);
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:14px;
      margin-top:12px;
    }
    @media (min-width:760px){
      .grid{grid-template-columns:repeat(3, minmax(0, 1fr));}
      .brand .name{font-size:26px}
    }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:0 8px 26px rgba(0,0,0,.05);
      display:flex;flex-direction:column;
      min-height:260px;
    }

    .thumb{
      width:100%;
      aspect-ratio: 1 / 1;
      background:#f1f1f3;
      position:relative;
      cursor:pointer;
    }
    .thumb img{
      width:100%;height:100%;object-fit:cover;display:block;
    }

    .content{
      padding:12px 12px 14px;
      display:flex;flex-direction:column;gap:10px;flex:1;
    }
    .title{
      font-size:14px;font-weight:800;line-height:1.25;
      margin:0;
      text-transform:lowercase;
    }
    .price{
      font-size:15px;font-weight:900;
      margin:0;
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}

    .btn{
      border:none;cursor:pointer;
      padding:10px 12px;
      border-radius:16px;
      font-weight:900;font-size:13px;
      text-transform:lowercase;
      user-select:none;
    }
    .btn.primary{ background:var(--primary); color:#1b1b1d; }
    .btn.primary:active{ background:var(--primaryActive); }
    .btn.secondary{ background:var(--secondary); color:#1b1b1d; }
    .btn.secondary:active{ background:var(--secondaryActive); }

    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .qty{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:6px 8px;
      background:rgba(255,255,255,.95);
    }
    .qty button{
      width:32px;height:32px;border-radius:14px;border:none;cursor:pointer;
      background:rgba(0,0,0,.04);
      font-weight:900;font-size:16px;
    }
    .qty span{min-width:20px;text-align:center;font-weight:900}

    /* ===== MODAL BASE (скролл) ===== */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.35);
      display:none;
      justify-content:center;
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      align-items:flex-start;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      height:var(--app-h);
    }
    .overlay.open{display:flex}

    .sheet{
      width:min(720px, 100%);
      background:var(--card);
      border-radius:26px;
      border:1px solid var(--stroke);
      box-shadow:0 18px 60px rgba(0,0,0,.18);
      overflow:hidden;
      max-height:calc(var(--app-h) - 20px);
      display:flex;
      flex-direction:column;
      margin:10px 0;
    }
    .sheetHeader{
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid var(--stroke);
      flex:0 0 auto;
    }
    .sheetHeader .h{
      font-weight:900;
      letter-spacing:.1px;
      text-transform:lowercase;
    }
    .iconBtn{
      border:none;background:transparent;cursor:pointer;
      font-size:20px;line-height:1;
      padding:6px 8px;border-radius:12px;
    }
    .sheetBody{
      padding:14px 16px 18px;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      flex:1 1 auto;
    }

    /* ===== PRODUCT FULLSCREEN ===== */
    #productOverlay.open{ padding:0; }
    #productOverlay .sheet{
      width:100%;
      max-width:100%;
      height:var(--app-h);
      max-height:var(--app-h);
      border-radius:0;
      margin:0;
      border:none;
    }
    #productOverlay .sheetBody{ padding:0; }

    .gallery{
      border-radius:0;
      overflow:hidden;
      border:none;
      background:#000;
      position:relative;
      user-select:none;
    }
    .gallery img{
      width:100%;
      height:65vh;
      object-fit:cover;
      display:block;
    }

    .dots{
      position:absolute;left:0;right:0;bottom:10px;
      display:flex;justify-content:center;gap:6px;
    }
    .dot{
      width:7px;height:7px;border-radius:999px;
      background:rgba(255,255,255,.65);
      border:1px solid rgba(0,0,0,.10);
    }
    .dot.on{background:var(--primary)}

    .desc{
      margin:12px 16px 0;
      color:var(--muted);
      font-size:13px;line-height:1.45;
      padding-bottom:10px;
    }

    .productFooter{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:0 16px 16px;
      flex-wrap:wrap;
    }
    .productFooter .actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .sectionTitle{
      margin:14px 0 8px;
      font-weight:900;
      font-size:13px;
      letter-spacing:.1px;
      text-transform:lowercase;
    }

    .form{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .field{
      display:flex;flex-direction:column;gap:6px;
    }
    .field label{
      font-size:12px;color:var(--muted);
      font-weight:700;
      text-transform:lowercase;
    }

    /* 16px фиксит авто-zoom на iOS */
    input, select, textarea{
      font-family:inherit;
      font-size:16px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:#fff;
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}

    .summary{
      margin-top:12px;
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:12px;
      background:rgba(0,0,0,.02);
      display:flex;flex-direction:column;gap:6px;
      font-size:13px;
    }
    .summary .line{display:flex;justify-content:space-between;gap:10px}
    .summary .total{font-weight:900;font-size:14px}

    .hint{
      margin-top:10px;
      font-size:12px;color:var(--muted);
      text-transform:lowercase;
    }

    .bottomBar{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(12px);
      border-top:1px solid var(--stroke);
      padding:10px 16px calc(10px + env(safe-area-inset-bottom));
    }
    .bottomInner{
      max-width:980px;margin:0 auto;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
    }
    .bottomInner .mini{
      font-size:13px;color:var(--muted);
      font-weight:700;
      text-transform:lowercase;
    }
    .bottomInner .mini b{color:var(--text);font-weight:900}

    /* ===== UX OVERLAY (замена alert) ===== */
    .uxOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px 16px calc(18px + env(safe-area-inset-bottom));
      background:rgba(0,0,0,.35);
      z-index:9999;
      height:var(--app-h);
    }
    .uxOverlay.open{display:flex}
    .uxCard{
      width:min(520px, 100%);
      background:#fff;
      border:1px solid var(--stroke);
      border-radius:26px;
      box-shadow:0 18px 60px rgba(0,0,0,.20);
      overflow:hidden;
    }
    .uxCardHeader{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--stroke);
    }
    .uxCardHeader .t{
      font-weight:900;
      text-transform:lowercase;
      letter-spacing:.1px;
    }
    .uxCardBody{
      padding:14px 16px 16px;
    }
    .uxText{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
      font-weight:700;
      text-transform:lowercase;
      white-space:pre-line;
    }
    .uxActions{
      padding:0 16px 16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* loader в кнопке */
    .spinner{
      width:16px;height:16px;
      border-radius:999px;
      border:3px solid rgba(0,0,0,.12);
      border-top-color: rgba(0,0,0,.75);
      display:inline-block;
      animation:spin .8s linear infinite;
      vertical-align:middle;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="name">дарицветы.москва</div>
        <div class="tag">доставка цветов</div>
      </div>
      <div class="pill" title="корзина">
        <button id="openCartBtn">корзина</button>
        <div class="count" id="cartCount">0</div>
      </div>
    </header>

    <div class="filters" id="filters" style="display:none;"></div>
    <div class="grid" id="grid"></div>
  </div>

  <div class="bottomBar" id="bottomBar" style="display:none;">
    <div class="bottomInner">
      <div class="mini">
        в корзине: <b id="bottomCount">0</b> • итого: <b id="bottomTotal">0 ₽</b>
      </div>
      <button class="btn primary" id="checkoutBtn">оформить</button>
    </div>
  </div>

  <!-- product modal -->
  <div class="overlay" id="productOverlay" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHeader">
        <div class="h" id="pTitle">товар</div>
        <button class="iconBtn" id="closeProduct">✕</button>
      </div>

      <div class="sheetBody">
        <div class="gallery" id="gallery">
          <img id="gImg" src="" alt="" />
          <div class="dots" id="dots"></div>
        </div>

        <div class="desc" id="pDesc"></div>

        <div class="productFooter">
          <p class="price" id="pPrice"></p>
          <div class="actions">
            <div id="pControls"></div>
            <button class="btn secondary" id="goCheckoutFromProduct" disabled>перейти к оформлению</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- cart/checkout modal -->
  <div class="overlay" id="cartOverlay" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHeader">
        <div class="h" id="cartTitle">корзина</div>
        <button class="iconBtn" id="closeCart">✕</button>
      </div>
      <div class="sheetBody">
        <div id="cartItems"></div>

        <div class="sectionTitle">доставка</div>
        <div class="form">
          <div class="field">
            <label>тип доставки</label>
            <select id="deliveryType">
              <option value="mkad">москва (в пределах мкад) — 650 ₽</option>
              <option value="pickup">самовывоз — Автозаводская 23с2</option>
              <option value="outside">за мкад — стоимость уточним</option>
            </select>
          </div>

          <div class="field">
            <label>дата</label>
            <input id="date" type="date" />
          </div>

          <div class="field">
            <label>интервал</label>
            <select id="timeSlot"></select>
          </div>

          <div class="field">
            <label>адрес</label>
            <input id="address" type="text" placeholder="пример: город, улица, дом, подъезд, квартира" />
          </div>

          <div class="sectionTitle">заказчик</div>

          <div class="field">
            <label>имя</label>
            <input id="customerName" type="text" placeholder="имя заказчика" />
          </div>

          <div class="field">
            <label>телефон</label>
            <input id="customerPhone" type="tel" placeholder="+7 (___) ___-__-__" inputmode="numeric" />
          </div>

          <div class="sectionTitle">получатель</div>

          <div class="field">
            <label style="display:flex; align-items:center; gap:10px;">
              <input id="sameAsCustomer" type="checkbox" />
              получатель совпадает с заказчиком
            </label>
          </div>

          <div id="recipientFields" class="form" style="padding:0; gap:10px;">
            <div class="field">
              <label>имя получателя</label>
              <input id="recipientName" type="text" placeholder="имя получателя" />
            </div>

            <div class="field">
              <label>телефон получателя</label>
              <input id="recipientPhone" type="tel" placeholder="+7 (___) ___-__-__" inputmode="numeric" />
            </div>
          </div>

          <div class="sectionTitle">открытка</div>

          <div class="field">
            <label style="display:flex; align-items:center; gap:10px;">
              <input id="cardNotNeeded" type="checkbox" />
              открытка не нужна
            </label>
          </div>

          <div class="field" id="cardTextField">
            <label>текст для открытки</label>
            <textarea id="cardText" placeholder="например: с днём рождения!"></textarea>
          </div>

          <div class="field">
            <label>комментарий (необязательно)</label>
            <textarea id="comment" placeholder="например: код домофона, пожелания по ленте"></textarea>
          </div>
        </div>

        <div class="summary" id="summary"></div>

        <button class="btn primary" id="submitOrder" style="width:100%; margin-top:12px; padding:14px 12px; border-radius:18px;">
          отправить заказ
        </button>

        <div class="hint">
          оплата: после подтверждения заказа мы пришлём ссылку на оплату
        </div>
      </div>
    </div>
  </div>

  <!-- UX overlay -->
  <div class="uxOverlay" id="uxOverlay" aria-hidden="true">
    <div class="uxCard">
      <div class="uxCardHeader">
        <div class="t" id="uxTitle">сообщение</div>
        <button class="iconBtn" id="uxCloseBtn">✕</button>
      </div>
      <div class="uxCardBody">
        <p class="uxText" id="uxText"></p>
      </div>
      <div class="uxActions" id="uxActions"></div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const API_BASE = "https://script.google.com/macros/s/AKfycbzdOFj8B64mrN1q_cmdhjOkvG4KsgZZP-6b2lpfdXBQ2-JUz3juEYcr76iPrvp5lGEhbA/exec";

  // поддержка
  const SUPPORT_USERNAME = "chaiori";
  const SUPPORT_URL = `https://t.me/${SUPPORT_USERNAME}`;

  // фиксированные слоты на будущие дни
  const TIME_SLOTS = ["10:00-14:00","14:00-18:00","18:00-22:00"];

  // динамика на сегодня: +3 часа, округление до 30 минут
  const DYNAMIC_LEAD_MINUTES = 180;
  const SLOT_STEP_MINUTES = 30;

  // РАБОЧЕЕ ВРЕМЯ ДОСТАВКИ
  const WORK_START_MINUTES = 10*60; // 10:00
  const WORK_END_MINUTES   = 22*60; // 22:00

  const DELIVERY_MKAD = 650;

  // ====== STATE ======
  let products = [];
  let cart = {};
  let currentProduct = null;
  let galleryIndex = 0;
  let activeCategory = "all";

  // ====== HELPERS ======
  const fmt = (n) => new Intl.NumberFormat("ru-RU").format(Number(n) || 0) + " ₽";
  const el = (id) => document.getElementById(id);

  function todayISO(){
    const d = new Date();
    const tz = new Date(d.getTime() - d.getTimezoneOffset()*60000);
    return tz.toISOString().slice(0,10);
  }

  function minutesNow(){
    const d = new Date();
    return d.getHours()*60 + d.getMinutes();
  }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function toHM(min){
    const h = Math.floor(min/60);
    const m = min%60;
    return `${pad2(h)}:${pad2(m)}`;
  }
  function ceilToStep(min, step){
    return Math.ceil(min/step)*step;
  }

  // СЛОТЫ: только 10:00–22:00; ночью начинаем от 10:00
  function availableSlotsForDate(dateISO){
    if (dateISO !== todayISO()) return TIME_SLOTS.slice();

    const now = minutesNow();

    const start = Math.max(
      WORK_START_MINUTES,
      ceilToStep(now + DYNAMIC_LEAD_MINUTES, SLOT_STEP_MINUTES)
    );

    if (start >= WORK_END_MINUTES) return [];

    const slots = [];
    for (let t = start; t < WORK_END_MINUTES; t += SLOT_STEP_MINUTES){
      const end = Math.min(t + 120, WORK_END_MINUTES);
      if ((end - t) < 60) continue;
      slots.push(`${toHM(t)}-${toHM(end)}`);
    }
    return slots;
  }

  function cartCount(){
    return Object.values(cart).reduce((a,b)=>a+b,0);
  }

  function cartItems(){
    return Object.entries(cart)
      .map(([id,qty]) => {
        const p = products.find(x => String(x.id) === String(id));
        return p ? ({ ...p, qty }) : null;
      })
      .filter(Boolean);
  }

  function cartSubtotal(){
    return cartItems().reduce((sum, it) => sum + (Number(it.price) * it.qty), 0);
  }

  function deliveryCost(){
    const t = el("deliveryType").value;
    if (t === "mkad") return DELIVERY_MKAD;
    if (t === "pickup") return 0;
    return null;
  }

  function updateCheckoutButtons(){
    const hasItems = cartCount() > 0;
    el("checkoutBtn").disabled = !hasItems;
    el("goCheckoutFromProduct").disabled = !hasItems;
  }

  function renderBottom(){
    const count = cartCount();
    el("cartCount").textContent = count;
    el("bottomCount").textContent = count;
    el("bottomTotal").textContent = fmt(cartSubtotal());
    el("bottomBar").style.display = count > 0 ? "block" : "none";
    updateCheckoutButtons();
  }

  function setQty(id, qty){
    const key = String(id);
    if (qty <= 0) delete cart[key];
    else cart[key] = qty;

    renderGrid();
    renderBottom();

    if (currentProduct && String(currentProduct.id) === key) {
      renderProductControls();
    }
  }

  // ===== стабилизация высоты webapp =====
  function setAppHeight(){
    const tg = window.Telegram?.WebApp;
    const h = (tg && tg.viewportHeight) ? tg.viewportHeight : window.innerHeight;
    document.documentElement.style.setProperty("--app-h", h + "px");
  }

  // ===== UX overlay =====
  function closeUX(){ el("uxOverlay").classList.remove("open"); }

  function openSupport(){
    try{
      const tg = window.Telegram?.WebApp;
      if (tg && typeof tg.openTelegramLink === "function"){
        tg.openTelegramLink(SUPPORT_URL);
        return;
      }
    } catch(_) {}
    window.open(SUPPORT_URL, "_blank");
  }

  function showUX({ title, text, actions = [] }){
    el("uxTitle").textContent = (title || "сообщение").toLowerCase();
    el("uxText").textContent = (text || "").toLowerCase();

    const a = el("uxActions");
    a.innerHTML = "";

    actions.forEach(btn => {
      const b = document.createElement("button");
      b.className = "btn " + (btn.kind === "secondary" ? "secondary" : "primary");
      b.textContent = (btn.text || "").toLowerCase();
      b.addEventListener("click", () => {
        if (btn.close !== false) closeUX();
        if (typeof btn.onClick === "function") btn.onClick();
      });
      a.appendChild(b);
    });

    if (actions.length === 0){
      const b = document.createElement("button");
      b.className = "btn primary";
      b.textContent = "ок";
      b.addEventListener("click", closeUX);
      a.appendChild(b);
    }

    el("uxOverlay").classList.add("open");
  }

  function showErrorUX(message){
    showUX({
      title: "не удалось",
      text: message || "не удалось отправить заказ. попробуй ещё раз или напиши нам в поддержку.",
      actions: [
        { text: "попробовать ещё раз", kind: "primary", onClick: ()=>{} },
        { text: "написать в поддержку", kind: "secondary", close: true, onClick: openSupport }
      ]
    });
  }

  function shortOrderCode(orderId){
    // ORD1234567890 -> 4 последние цифры
    const digits = String(orderId || "").replace(/\D/g, "");
    if (digits.length >= 4) return digits.slice(-4);
    // если вдруг пришло что-то другое
    return (String(orderId || "").slice(-4) || "—");
  }

  function showSuccessUX(orderId){
    const code4 = shortOrderCode(orderId);
    const txt =
      `заказ отправлен.\nномер: ${code4}.\nмы свяжемся для подтверждения и оплаты.`;

    showUX({
      title: "готово",
      text: txt,
      actions: [
        { text: "вернуться в каталог", kind: "primary", onClick: ()=>{} }
      ]
    });
  }

  // ===== GOOGLE DRIVE IMAGE =====
  function extractDriveId(s){
    if (!s) return null;
    const str = String(s);

    let m = str.match(/drive\.google\.com\/file\/d\/([^/]+)\//);
    if (m && m[1]) return m[1];

    m = str.match(/[?&]id=([^&]+)/);
    if (m && m[1]) return m[1];

    m = str.match(/drive\.google\.com\/open\?id=([^&]+)/);
    if (m && m[1]) return m[1];

    return null;
  }

  function driveCandidates(url){
    if (!url) return [];
    const id = extractDriveId(url);
    if (!id) return [String(url)];

    return [
      `https://drive.google.com/thumbnail?id=${id}&sz=w2000`,
      `https://drive.google.com/uc?export=view&id=${id}`,
      `https://drive.google.com/uc?export=download&id=${id}`
    ];
  }

  function setImgWithFallback(imgEl, url){
    const list = driveCandidates(url);
    if (list.length === 0){
      imgEl.removeAttribute("src");
      return;
    }
    let idx = 0;
    imgEl.onerror = () => {
      idx += 1;
      if (idx < list.length){
        imgEl.src = list[idx];
      } else {
        imgEl.onerror = null;
        imgEl.removeAttribute("src");
      }
    };
    imgEl.src = list[0];
  }

  function nonEmptyPhotos(arr){
    return (Array.isArray(arr) ? arr : []).map(x => String(x || "").trim()).filter(Boolean);
  }

  // ===== FILTERS =====
  function getCategory(p){
    const raw = (p.category ?? p.wrap ?? "").toString().trim();
    return raw ? raw : "без категории";
  }

  function renderFilters(){
    const root = el("filters");
    const cats = Array.from(new Set(products.map(getCategory))).filter(Boolean);

    if (cats.length <= 1){
      root.style.display = "none";
      return;
    }

    root.style.display = "flex";
    root.innerHTML = "";

    const allChip = document.createElement("button");
    allChip.className = "chip" + (activeCategory === "all" ? " on" : "");
    allChip.textContent = "все";
    allChip.onclick = () => { activeCategory = "all"; renderFilters(); renderGrid(); };
    root.appendChild(allChip);

    cats.forEach(c => {
      const chip = document.createElement("button");
      chip.className = "chip" + (activeCategory === c ? " on" : "");
      chip.textContent = c.toLowerCase();
      chip.onclick = () => { activeCategory = c; renderFilters(); renderGrid(); };
      root.appendChild(chip);
    });
  }

  // ====== UI: GRID ======
  function renderGrid(){
    const grid = el("grid");
    grid.innerHTML = "";

    if (!Array.isArray(products) || products.length === 0){
      grid.innerHTML = `
        <div style="grid-column:1/-1; padding:14px; border:1px solid var(--stroke); border-radius:var(--radius); background:#fff; color:var(--muted); font-weight:700; text-transform:lowercase;">
          товаров пока нет
        </div>
      `;
      return;
    }

    const shown = (activeCategory === "all")
      ? products
      : products.filter(p => getCategory(p) === activeCategory);

    if (shown.length === 0){
      grid.innerHTML = `
        <div style="grid-column:1/-1; padding:14px; border:1px solid var(--stroke); border-radius:var(--radius); background:#fff; color:var(--muted); font-weight:700; text-transform:lowercase;">
          в этой категории пока нет товаров
        </div>
      `;
      return;
    }

    shown.forEach(p => {
      const id = String(p.id);
      const card = document.createElement("div");
      card.className = "card";

      const thumb = document.createElement("div");
      thumb.className = "thumb";

      const img = document.createElement("img");
      img.alt = p.name || "";
      const photos = nonEmptyPhotos(p.photos);
      if (photos[0]) setImgWithFallback(img, photos[0]);
      thumb.appendChild(img);

      thumb.addEventListener("click", () => openProduct(id));

      const content = document.createElement("div");
      content.className = "content";

      const title = document.createElement("p");
      title.className = "title";
      title.textContent = (p.name || "").toLowerCase();

      const row = document.createElement("div");
      row.className = "row";

      const price = document.createElement("p");
      price.className = "price";
      price.textContent = fmt(p.price);

      const controls = document.createElement("div");
      const qty = cart[id] || 0;

      if (qty <= 0){
        const btn = document.createElement("button");
        btn.className = "btn primary";
        btn.textContent = "в корзину";
        btn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          setQty(id, 1);
        });
        controls.appendChild(btn);
      } else {
        const box = document.createElement("div");
        box.className = "qty";

        const minus = document.createElement("button");
        minus.textContent = "–";
        minus.addEventListener("click", (ev) => {
          ev.stopPropagation();
          setQty(id, qty-1);
        });

        const n = document.createElement("span");
        n.textContent = qty;

        const plus = document.createElement("button");
        plus.textContent = "+";
        plus.addEventListener("click", (ev) => {
          ev.stopPropagation();
          setQty(id, qty+1);
        });

        box.append(minus, n, plus);
        controls.appendChild(box);
      }

      row.append(price, controls);
      content.append(title, row);

      card.append(thumb, content);
      grid.appendChild(card);
    });
  }

  // ====== UI: PRODUCT MODAL ======
  function openProduct(id){
    const p = products.find(x => String(x.id) === String(id));
    if (!p) return;

    currentProduct = p;
    galleryIndex = 0;

    el("pTitle").textContent = (p.name || "товар").toLowerCase();
    el("pDesc").textContent = p.description || "";
    el("pPrice").textContent = fmt(p.price);

    renderGallery();
    renderProductControls();

    el("productOverlay").classList.add("open");
    updateCheckoutButtons();
  }

  function closeProduct(){
    el("productOverlay").classList.remove("open");
  }

  function renderGallery(){
    const photos = nonEmptyPhotos(currentProduct?.photos);
    const img = el("gImg");

    if (!photos.length){
      img.removeAttribute("src");
    } else {
      setImgWithFallback(img, photos[galleryIndex] || photos[0]);
    }

    const dots = el("dots");
    dots.innerHTML = "";
    photos.forEach((_, i) => {
      const d = document.createElement("div");
      d.className = "dot" + (i === galleryIndex ? " on" : "");
      d.addEventListener("click", () => { galleryIndex = i; renderGallery(); });
      dots.appendChild(d);
    });

    let startX = null;
    const gallery = el("gallery");
    gallery.ontouchstart = (ev)=>{ startX = ev.touches[0].clientX; };
    gallery.ontouchend = (ev)=>{
      if (startX === null) return;
      const endX = ev.changedTouches[0].clientX;
      const dx = endX - startX;
      startX = null;

      if (Math.abs(dx) < 40) return;
      const len = photos.length;
      if (!len) return;

      if (dx < 0) galleryIndex = Math.min(len-1, galleryIndex+1);
      else galleryIndex = Math.max(0, galleryIndex-1);

      renderGallery();
    };
  }

  function renderProductControls(){
    const p = currentProduct;
    const box = el("pControls");
    box.innerHTML = "";
    if (!p) return;

    const id = String(p.id);
    const qty = cart[id] || 0;

    if (qty <= 0){
      const btn = document.createElement("button");
      btn.className = "btn primary";
      btn.textContent = "в корзину";
      btn.addEventListener("click", () => {
        setQty(id, 1);
        updateCheckoutButtons();
      });
      box.appendChild(btn);
    } else {
      const q = document.createElement("div");
      q.className = "qty";

      const minus = document.createElement("button");
      minus.textContent = "–";
      minus.addEventListener("click", () => { setQty(id, qty-1); updateCheckoutButtons(); });

      const n = document.createElement("span");
      n.textContent = qty;

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.addEventListener("click", () => { setQty(id, qty+1); updateCheckoutButtons(); });

      q.append(minus, n, plus);
      box.appendChild(q);
    }
  }

  // ====== CART / CHECKOUT ======
  function openCart(){
    renderCart();
    el("cartOverlay").classList.add("open");
    updateCheckoutButtons();
  }
  function closeCart(){
    el("cartOverlay").classList.remove("open");
  }

  function renderCart(){
    const items = cartItems();
    const root = el("cartItems");
    root.innerHTML = "";

    if (items.length === 0){
      root.innerHTML = `<div style="color:var(--muted);font-size:13px;font-weight:700;text-transform:lowercase;">корзина пустая</div>`;
      el("summary").innerHTML = "";
      return;
    }

    items.forEach(it => {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.gap = "10px";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.padding = "10px 0";
      row.style.borderBottom = "1px solid var(--stroke)";

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";
      left.style.gap = "4px";

      const nm = document.createElement("div");
      nm.style.fontWeight = "900";
      nm.style.fontSize = "13px";
      nm.style.textTransform = "lowercase";
      nm.textContent = (it.name || "").toLowerCase();

      const pr = document.createElement("div");
      pr.style.color = "var(--muted)";
      pr.style.fontSize = "12px";
      pr.style.fontWeight = "700";
      pr.style.textTransform = "lowercase";
      pr.textContent = `${fmt(it.price)} × ${it.qty}`;

      left.append(nm, pr);

      const q = document.createElement("div");
      q.className = "qty";

      const minus = document.createElement("button");
      minus.textContent = "–";
      minus.addEventListener("click", () => { setQty(it.id, it.qty-1); renderCart(); });

      const n = document.createElement("span");
      n.textContent = it.qty;

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.addEventListener("click", () => { setQty(it.id, it.qty+1); renderCart(); });

      q.append(minus, n, plus);

      row.append(left, q);
      root.appendChild(row);
    });

    renderSummary();
  }

  function renderTimeSlots(){
    const dateISO = el("date").value || todayISO();
    const slots = availableSlotsForDate(dateISO);

    const select = el("timeSlot");
    select.innerHTML = "";

    if (slots.length === 0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "на выбранную дату слотов нет";
      select.appendChild(opt);
      select.disabled = true;
      return;
    }

    select.disabled = false;
    slots.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      select.appendChild(opt);
    });
  }

  function renderSummary(){
    const sub = cartSubtotal();
    const dType = el("deliveryType").value;
    const dCost = deliveryCost();

    const lines = [];
    lines.push(`<div class="line"><span>товары</span><span>${fmt(sub)}</span></div>`);

    if (dType === "mkad"){
      lines.push(`<div class="line"><span>доставка</span><span>${fmt(dCost)}</span></div>`);
      lines.push(`<div class="line total"><span>итого</span><span>${fmt(sub + dCost)}</span></div>`);
    } else if (dType === "pickup"){
      lines.push(`<div class="line"><span>самовывоз</span><span>${fmt(0)}</span></div>`);
      lines.push(`<div class="line"><span>адрес</span><span>Автозаводская 23с2</span></div>`);
      lines.push(`<div class="line total"><span>итого</span><span>${fmt(sub)}</span></div>`);
    } else {
      lines.push(`<div class="line"><span>доставка</span><span>уточним</span></div>`);
      lines.push(`<div class="line total"><span>итого</span><span>${fmt(sub)}</span></div>`);
    }

    el("summary").innerHTML = lines.join("");
  }

  // ===== PHONE MASK + VALIDATION =====
  function onlyDigits(s){ return String(s || "").replace(/\D/g, ""); }

  function formatPhoneRU(value){
    let d = onlyDigits(value);
    if (d.startsWith("8")) d = "7" + d.slice(1);
    if (d.length && !d.startsWith("7")) d = "7" + d;
    d = d.slice(0, 11);

    const p = d.slice(1);
    const a = p.slice(0,3);
    const b = p.slice(3,6);
    const c = p.slice(6,8);
    const e = p.slice(8,10);

    let out = "+7";
    if (a) out += " (" + a;
    if (a.length === 3) out += ")";
    if (b) out += " " + b;
    if (c) out += "-" + c;
    if (e) out += "-" + e;
    return out;
  }

  function normalizePhoneRU(value){
    let d = onlyDigits(value);
    if (d.startsWith("8")) d = "7" + d.slice(1);
    if (d.length && !d.startsWith("7")) d = "7" + d;
    return d.slice(0, 11);
  }

  function isValidPhoneRU(value){
    const d = normalizePhoneRU(value);
    return d.length === 11 && d.startsWith("7");
  }

  function attachPhoneMask(inputId){
    const inp = el(inputId);
    inp.addEventListener("input", () => {
      const caretAtEnd = inp.selectionStart === inp.value.length;
      inp.value = formatPhoneRU(inp.value);
      if (caretAtEnd) inp.setSelectionRange(inp.value.length, inp.value.length);
    });
  }

  function syncRecipientIfSame(){
    if (!el("sameAsCustomer").checked) return;
    el("recipientName").value = el("customerName").value.trim();
    el("recipientPhone").value = el("customerPhone").value.trim();
  }

  function setSubmitLoading(isLoading){
    const btn = el("submitOrder");
    if (!btn) return;

    if (isLoading){
      btn.disabled = true;
      btn.dataset.prev = btn.textContent;
      btn.innerHTML = `<span class="spinner"></span> отправляем…`;
    } else {
      btn.disabled = false;
      btn.textContent = btn.dataset.prev || "отправить заказ";
      btn.dataset.prev = "";
    }
  }

  async function submitOrder(){
    const items = cartItems();
    if (items.length === 0){
      showUX({ title:"корзина пустая", text:"добавь товары и попробуй ещё раз." });
      return;
    }

    const customer_name = el("customerName").value.trim();
    const customer_phone = el("customerPhone").value.trim();

    const delivery_type = el("deliveryType").value;

    const address = el("address").value.trim(); // не обязателен
    const date = el("date").value;
    const time_slot = el("timeSlot").value;

    const same = el("sameAsCustomer").checked;
    const recipient_name = same ? customer_name : el("recipientName").value.trim();
    const recipient_phone = same ? customer_phone : el("recipientPhone").value.trim();

    if (!customer_name || !customer_phone || !recipient_name || !recipient_phone || !date || !time_slot){
      showUX({ title:"проверь поля", text:"нужны: заказчик, получатель, дата и интервал." });
      return;
    }

    if (!isValidPhoneRU(customer_phone)){
      showUX({ title:"телефон", text:"проверь телефон заказчика: нужен полный номер рф (+7…)." });
      return;
    }
    if (!isValidPhoneRU(recipient_phone)){
      showUX({ title:"телефон", text:"проверь телефон получателя: нужен полный номер рф (+7…)." });
      return;
    }

    const slots = availableSlotsForDate(date);
    if (!slots.includes(time_slot)){
      renderTimeSlots();
      showUX({ title:"интервал", text:"этот интервал уже недоступен. выбери другой." });
      return;
    }

    const delivery_price = (delivery_type === "mkad") ? DELIVERY_MKAD : (delivery_type === "pickup" ? 0 : "уточним");

    let finalAddress = address;
    if (delivery_type === "pickup"){
      finalAddress = "Самовывоз: Автозаводская 23с2";
    }

    const card_not_needed = el("cardNotNeeded").checked;
    const card_text = card_not_needed ? "" : (el("cardText").value || "").trim();

    const payload = {
      action: "create_order",
      tg_user_id: 0,
      tg_username: "",
      customer_name,
      customer_phone: normalizePhoneRU(customer_phone),
      recipient_name,
      recipient_phone: normalizePhoneRU(recipient_phone),
      same_as_customer: same,
      address: finalAddress,
      date,
      time_slot,
      delivery_type,
      delivery_price,
      total: (delivery_type === "mkad") ? (cartSubtotal() + DELIVERY_MKAD) : cartSubtotal(),
      items: items.map(it => ({ id: it.id, name: it.name, qty: it.qty, price: it.price })),
      card_not_needed,
      card_text,
      comment: (el("comment").value || "").trim()
    };

    // Telegram WebApp context
    try{
      if (window.Telegram && window.Telegram.WebApp){
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand?.();
        const u = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
        if (u){
          payload.tg_user_id = u.id || 0;
          payload.tg_username = u.username || "";
        }
      }
    } catch(_) {}

    setSubmitLoading(true);

    try{
      // ВАЖНО: text/plain -> без preflight, стабильнее для GAS
      const res = await fetch(API_BASE, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      const raw = await res.text();
      let json = null;
      try { json = JSON.parse(raw); } catch(_) {}

      if (!res.ok){
        throw new Error(json?.error || raw || `http ${res.status}`);
      }
      if (json && json.status === "error"){
        throw new Error(json.error || "ошибка сервера");
      }

      const orderId = json?.order_id || "";

      cart = {};
      renderBottom();
      renderGrid();
      closeCart();
      closeProduct();

      showSuccessUX(orderId);
    } catch(err){
      console.error(err);
      showErrorUX("не удалось отправить заказ. попробуй ещё раз или напиши нам в поддержку.");
    } finally{
      setSubmitLoading(false);
    }
  }

  // ====== INIT ======
  async function loadProducts(){
    const url = `${API_BASE}?action=products`;
    const res = await fetch(url, { method:"GET", cache:"no-store" });
    if (!res.ok) throw new Error(`GET products: HTTP ${res.status}`);

    const json = await res.json();
    const arr = Array.isArray(json) ? json : (json && Array.isArray(json.products) ? json.products : []);

    products = arr.map((p, i) => ({
      id: (p.id ?? p.sku ?? p.code ?? i).toString(),
      name: p.name ?? p.title ?? "без названия",
      price: Number(p.price ?? p.cost ?? 0) || 0,
      description: p.description ?? p.desc ?? "",
      photos: nonEmptyPhotos(Array.isArray(p.photos) ? p.photos : (Array.isArray(p.images) ? p.images : [])),
      category: (p.category ?? p.wrap ?? "").toString().trim(),
      wrap: (p.wrap ?? "").toString().trim()
    }));
  }

  function initForm(){
    el("date").value = todayISO();
    renderTimeSlots();

    el("date").addEventListener("change", () => {
      renderTimeSlots();
    });

    el("deliveryType").addEventListener("change", () => {
      const t = el("deliveryType").value;

      if (t === "pickup"){
        el("address").value = "";
        el("address").disabled = true;
        el("address").placeholder = "пример: самовывоз — Автозаводская 23с2";
      } else {
        el("address").disabled = false;
        el("address").placeholder = "пример: город, улица, дом, подъезд, квартира";
      }

      renderSummary();
      renderBottom();
    });

    el("sameAsCustomer").addEventListener("change", () => {
      const same = el("sameAsCustomer").checked;
      el("recipientFields").style.display = same ? "none" : "grid";
      if (same) syncRecipientIfSame();
    });

    el("customerName").addEventListener("input", syncRecipientIfSame);
    el("customerPhone").addEventListener("input", syncRecipientIfSame);

    el("cardNotNeeded").addEventListener("change", () => {
      const off = el("cardNotNeeded").checked;
      el("cardTextField").style.display = off ? "none" : "flex";
      if (off) el("cardText").value = "";
    });

    attachPhoneMask("customerPhone");
    attachPhoneMask("recipientPhone");

    el("recipientFields").style.display = "grid";
    el("cardTextField").style.display = "flex";
    renderSummary();
  }

  function initUI(){
    el("openCartBtn").addEventListener("click", openCart);
    el("checkoutBtn").addEventListener("click", openCart);

    el("closeCart").addEventListener("click", closeCart);
    el("closeProduct").addEventListener("click", closeProduct);

    el("cartOverlay").addEventListener("click", (e) => {
      if (e.target === el("cartOverlay")) closeCart();
    });
    el("productOverlay").addEventListener("click", (e) => {
      if (e.target === el("productOverlay")) closeProduct();
    });

    el("goCheckoutFromProduct").addEventListener("click", () => {
      if (cartCount() <= 0) return;
      closeProduct();
      openCart();
    });

    el("submitOrder").addEventListener("click", submitOrder);

    el("uxCloseBtn").addEventListener("click", closeUX);
    el("uxOverlay").addEventListener("click", (e) => {
      if (e.target === el("uxOverlay")) closeUX();
    });
  }

  async function boot(){
    initUI();
    initForm();

    try{
      const tg = window.Telegram?.WebApp;
      if (tg){
        tg.ready();
        tg.expand?.();
        setAppHeight();
        tg.onEvent?.("viewportChanged", setAppHeight);
      } else {
        setAppHeight();
      }
    } catch(_) {
      setAppHeight();
    }
    window.addEventListener("resize", setAppHeight);

    try{
      el("grid").innerHTML = `
        <div style="grid-column:1/-1; padding:14px; border:1px solid var(--stroke); border-radius:var(--radius); background:#fff; color:var(--muted); font-weight:700; text-transform:lowercase;">
          загружаем товары…
        </div>
      `;

      await loadProducts();
      renderFilters();
      renderGrid();
      renderBottom();
    } catch (err){
      console.error(err);
      el("grid").innerHTML = `
        <div style="grid-column:1/-1; padding:14px; border:1px solid var(--stroke); border-radius:var(--radius); background:#fff; color:var(--muted); font-weight:700; text-transform:lowercase;">
          не удалось загрузить каталог: <span style="color:var(--text); font-weight:900;">${String(err?.message || "ошибка")}</span>
          <div style="margin-top:10px;">
            <button class="btn secondary" style="padding:10px 12px;" onclick="(${openSupport.toString()})()">написать в поддержку</button>
          </div>
        </div>
      `;
    }
  }

  document.addEventListener("DOMContentLoaded", boot);
</script>

</body>
</html>
