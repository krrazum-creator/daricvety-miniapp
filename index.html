<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>дарицветы.москва — доставка цветов</title>

  <!-- font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#FFFDF8;
      --text:#1C1C1E;
      --muted:#6B6B73;
      --card:#FFFFFF;
      --stroke:rgba(0,0,0,.08);

      --primary:#F6E7A1;
      --primaryActive:#F3E39A;

      --secondary:#f7d8dc;
      --secondaryActive:#f2c7ce;

      --radius:22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Manrope",-apple-system,system-ui,"SF Pro Text","SF Pro Display",Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{max-width:980px;margin:0 auto;padding:20px 16px 120px}

    header{
      padding:10px 0 16px;
      display:flex;align-items:flex-end;justify-content:space-between;gap:12px;
    }
    .brand{line-height:1.1}
    .brand .name{font-size:22px;font-weight:800;letter-spacing:.1px}
    .brand .tag{margin-top:6px;font-size:13px;color:var(--muted);font-weight:600}

    .pill{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.75);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      display:flex;align-items:center;gap:10px;
    }
    .pill button{
      border:none;background:transparent;color:var(--text);
      font-weight:800;font-size:13px;cursor:pointer;
      text-transform:lowercase;
    }
    .pill .count{
      min-width:22px;height:22px;border-radius:999px;
      background:var(--primary);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:12px;
      border:1px solid rgba(0,0,0,.06);
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:14px;
      margin-top:10px;
    }
    @media (min-width:760px){
      .grid{grid-template-columns:repeat(3, minmax(0, 1fr));}
      .brand .name{font-size:26px}
    }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:0 8px 26px rgba(0,0,0,.05);
      display:flex;flex-direction:column;
      min-height:260px;
    }

    .thumb{
      width:100%;
      aspect-ratio: 1 / 1;
      background:#f1f1f3;
      position:relative;
      cursor:pointer;
    }
    .thumb img{
      width:100%;height:100%;object-fit:cover;display:block;
    }

    .content{
      padding:12px 12px 14px;
      display:flex;flex-direction:column;gap:10px;flex:1;
    }
    .title{
      font-size:14px;font-weight:800;line-height:1.25;
      margin:0;
      text-transform:lowercase;
    }
    .price{
      font-size:15px;font-weight:900;
      margin:0;
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}

    .btn{
      border:none;cursor:pointer;
      padding:10px 12px;
      border-radius:16px;
      font-weight:900;font-size:13px;
      text-transform:lowercase;
    }
    .btn.primary{
      background:var(--primary);
      color:#1b1b1d;
    }
    .btn.primary:active{background:var(--primaryActive)}
    .btn.secondary{
      background:var(--secondary);
      color:#1b1b1d;
    }
    .btn.secondary:active{background:var(--secondaryActive)}

    .qty{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:6px 8px;
      background:rgba(255,255,255,.8);
    }
    .qty button{
      width:32px;height:32px;border-radius:14px;border:none;cursor:pointer;
      background:rgba(0,0,0,.04);
      font-weight:900;font-size:16px;
    }
    .qty span{min-width:20px;text-align:center;font-weight:900}

    /* ===== MODAL BASE ===== */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.35);
      display:none;
      justify-content:center;
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      align-items:flex-start;                 /* важно для скролла */
      overflow-y:auto;                        /* важно для скролла */
      -webkit-overflow-scrolling:touch;
    }
    .overlay.open{display:flex}

    .sheet{
      width:min(720px, 100%);
      background:var(--card);
      border-radius:26px;
      border:1px solid var(--stroke);
      box-shadow:0 18px 60px rgba(0,0,0,.18);
      overflow:hidden;
      max-height:calc(100vh - 20px);         /* важно */
      display:flex;
      flex-direction:column;
      margin:10px 0;
    }
    .sheetHeader{
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid var(--stroke);
      flex:0 0 auto;
    }
    .sheetHeader .h{
      font-weight:900;
      letter-spacing:.1px;
      text-transform:lowercase;
    }
    .iconBtn{
      border:none;background:transparent;cursor:pointer;
      font-size:20px;line-height:1;
      padding:6px 8px;border-radius:12px;
    }
    .sheetBody{
      padding:14px 16px 18px;
      overflow-y:auto;                        /* важно */
      -webkit-overflow-scrolling:touch;
      flex:1 1 auto;
    }

    /* ===== PRODUCT FULLSCREEN ===== */
    #productOverlay.open{
      padding:0;
    }
    #productOverlay .sheet{
      width:100%;
      max-width:100%;
      height:100vh;
      max-height:100vh;
      border-radius:0;
      margin:0;
      border:none;
    }
    #productOverlay .sheetBody{
      padding:0;
    }

    .gallery{
      border-radius:0;
      overflow:hidden;
      border:none;
      background:#000;                        /* поля выглядят ок */
      position:relative;
      user-select:none;
    }
    .gallery img{
      width:100%;
      height:auto;
      max-height:78vh;                        /* главное: пропорции */
      object-fit:contain;                     /* НЕ обрезаем */
      display:block;
      margin:0 auto;
    }
    .dots{
      position:absolute;left:0;right:0;bottom:10px;
      display:flex;justify-content:center;gap:6px;
    }
    .dot{
      width:7px;height:7px;border-radius:999px;
      background:rgba(255,255,255,.65);
      border:1px solid rgba(0,0,0,.10);
    }
    .dot.on{background:var(--primary)}

    .desc{
      margin:12px 16px 0;
      color:var(--muted);
      font-size:13px;line-height:1.45;
      padding-bottom:10px;
    }

    .sectionTitle{
      margin:14px 0 8px;
      font-weight:900;
      font-size:13px;
      letter-spacing:.1px;
      text-transform:lowercase;
    }

    .form{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .field{
      display:flex;flex-direction:column;gap:6px;
    }
    .field label{
      font-size:12px;color:var(--muted);
      font-weight:700;
      text-transform:lowercase;
    }
    input, select, textarea{
      font-family:inherit;
      font-size:14px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:#fff;
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}

    .summary{
      margin-top:12px;
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:12px;
      background:rgba(0,0,0,.02);
      display:flex;flex-direction:column;gap:6px;
      font-size:13px;
    }
    .summary .line{display:flex;justify-content:space-between;gap:10px}
    .summary .total{font-weight:900;font-size:14px}

    .hint{
      margin-top:10px;
      font-size:12px;color:var(--muted);
      text-transform:lowercase;
    }

    .bottomBar{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(255,255,255,.82);
      backdrop-filter: blur(12px);
      border-top:1px solid var(--stroke);
      padding:10px 16px calc(10px + env(safe-area-inset-bottom));
    }
    .bottomInner{
      max-width:980px;margin:0 auto;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
    }
    .bottomInner .mini{
      font-size:13px;color:var(--muted);
      font-weight:700;
      text-transform:lowercase;
    }
    .bottomInner .mini b{color:var(--text);font-weight:900}

    .linkRow{
      display:flex;gap:10px;justify-content:flex-end;align-items:center;margin:16px 16px 16px
    }
    .productFooterRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:0 16px 16px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="name">дарицветы.москва</div>
        <div class="tag">доставка цветов</div>
      </div>
      <div class="pill" title="корзина">
        <button id="openCartBtn">корзина</button>
        <div class="count" id="cartCount">0</div>
      </div>
    </header>

    <div class="grid" id="grid"></div>
  </div>

  <!-- bottom bar -->
  <div class="bottomBar" id="bottomBar" style="display:none;">
    <div class="bottomInner">
      <div class="mini">
        в корзине: <b id="bottomCount">0</b> • итого: <b id="bottomTotal">0 ₽</b>
      </div>
      <button class="btn primary" id="checkoutBtn">оформить</button>
    </div>
  </div>

  <!-- product modal -->
  <div class="overlay" id="productOverlay" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHeader">
        <div class="h" id="pTitle">товар</div>
        <button class="iconBtn" id="closeProduct">✕</button>
      </div>

      <div class="sheetBody">
        <div class="gallery" id="gallery">
          <img id="gImg" src="" alt="" />
          <div class="dots" id="dots"></div>
        </div>

        <div class="desc" id="pDesc"></div>

        <div class="productFooterRow">
          <p class="price" id="pPrice"></p>
          <div id="pControls"></div>
        </div>

        <div class="linkRow">
          <button class="btn secondary" id="goCheckoutFromProduct">перейти к оформлению</button>
        </div>
      </div>
    </div>
  </div>

  <!-- cart/checkout modal -->
  <div class="overlay" id="cartOverlay" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHeader">
        <div class="h" id="cartTitle">корзина</div>
        <button class="iconBtn" id="closeCart">✕</button>
      </div>
      <div class="sheetBody">
        <div id="cartItems"></div>

        <div class="sectionTitle">доставка</div>
        <div class="form">
          <div class="field">
            <label>тип доставки</label>
            <select id="deliveryType">
              <option value="mkad">москва (в пределах мкад) — 650 ₽</option>
              <option value="pickup">самовывоз — Автозаводская 23с2</option>
              <option value="outside">за мкад — стоимость уточним</option>
            </select>
          </div>

          <div class="field">
            <label>дата</label>
            <input id="date" type="date" />
          </div>

          <div class="field">
            <label>интервал</label>
            <select id="timeSlot"></select>
          </div>

          <div class="field">
            <label>адрес</label>
            <input id="address" type="text" placeholder="город, улица, дом, подъезд, квартира" />
          </div>

          <div class="sectionTitle">заказчик</div>

          <div class="field">
            <label>имя</label>
            <input id="customerName" type="text" placeholder="имя заказчика" />
          </div>

          <div class="field">
            <label>телефон</label>
            <input id="customerPhone" type="tel" placeholder="+7..." />
          </div>

          <div class="sectionTitle">получатель</div>

          <div class="field">
            <label style="display:flex; align-items:center; gap:10px;">
              <input id="sameAsCustomer" type="checkbox" />
              получатель совпадает с заказчиком
            </label>
          </div>

          <div id="recipientFields" class="form" style="padding:0; gap:10px;">
            <div class="field">
              <label>имя получателя</label>
              <input id="recipientName" type="text" placeholder="имя получателя" />
            </div>

            <div class="field">
              <label>телефон получателя</label>
              <input id="recipientPhone" type="tel" placeholder="+7..." />
            </div>
          </div>

          <div class="field">
            <label>комментарий (необязательно)</label>
            <textarea id="comment" placeholder="например: код домофона, пожелания по ленте"></textarea>
          </div>
        </div>

        <div class="summary" id="summary"></div>

        <button class="btn primary" id="submitOrder" style="width:100%; margin-top:12px; padding:14px 12px; border-radius:18px;">
          отправить заказ
        </button>

        <div class="hint">
          оплата: после подтверждения заказа мы пришлём ссылку на оплату
        </div>
      </div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const API_BASE = "https://script.google.com/macros/s/AKfycbzdOFj8B64mrN1q_cmdhjOkvG4KsgZZP-6b2lpfdXBQ2-JUz3juEYcr76iPrvp5lGEhbA/exec";

  // На будущие дни оставляем фиксированные слоты:
  const TIME_SLOTS = ["10:00-14:00","14:00-18:00","18:00-22:00"];

  // Для "сегодня" делаем динамические слоты от текущего времени + 3 часа
  const DYNAMIC_LEAD_MINUTES = 180;     // можно 120, если хочешь "через 2 часа"
  const SLOT_STEP_MINUTES = 30;
  const SLOT_WINDOW_MINUTES = 120;
  const DAY_END_MINUTES = 22*60;

  const DELIVERY_MKAD = 650;

  // ====== STATE ======
  let products = [];
  let cart = {}; // {id: qty}
  let currentProduct = null;
  let galleryIndex = 0;

  // ====== HELPERS ======
  const fmt = (n) => new Intl.NumberFormat("ru-RU").format(Number(n) || 0) + " ₽";
  const el = (id) => document.getElementById(id);

  function todayISO(){
    const d = new Date();
    const tz = new Date(d.getTime() - d.getTimezoneOffset()*60000);
    return tz.toISOString().slice(0,10);
  }

  function minutesNow(){
    const d = new Date();
    return d.getHours()*60 + d.getMinutes();
  }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function toHM(min){
    const h = Math.floor(min/60);
    const m = min%60;
    return `${pad2(h)}:${pad2(m)}`;
  }
  function ceilToStep(min, step){
    return Math.ceil(min/step)*step;
  }

  function availableSlotsForDate(dateISO){
    // Для будущих дат — фиксированные интервалы:
    if (dateISO !== todayISO()) return TIME_SLOTS.slice();

    // Для сегодня — динамика
    const now = minutesNow();
    const start = ceilToStep(now + DYNAMIC_LEAD_MINUTES, SLOT_STEP_MINUTES);

    const slots = [];
    for (let t = start; t + SLOT_WINDOW_MINUTES <= DAY_END_MINUTES; t += SLOT_STEP_MINUTES){
      slots.push(`${toHM(t)}-${toHM(t + SLOT_WINDOW_MINUTES)}`);
    }
    return slots;
  }

  function cartCount(){
    return Object.values(cart).reduce((a,b)=>a+b,0);
  }

  function cartItems(){
    return Object.entries(cart)
      .map(([id,qty]) => {
        const p = products.find(x => String(x.id) === String(id));
        return p ? ({ ...p, qty }) : null;
      })
      .filter(Boolean);
  }

  function cartSubtotal(){
    return cartItems().reduce((sum, it) => sum + (Number(it.price) * it.qty), 0);
  }

  function deliveryCost(){
    const t = el("deliveryType").value;
    if (t === "mkad") return DELIVERY_MKAD;
    if (t === "pickup") return 0;
    return null; // outside
  }

  function renderBottom(){
    const count = cartCount();
    el("cartCount").textContent = count;
    el("bottomCount").textContent = count;

    // ВАЖНО: на главной показываем сумму БЕЗ доставки
    el("bottomTotal").textContent = fmt(cartSubtotal());

    el("bottomBar").style.display = count > 0 ? "block" : "none";
  }

  function setQty(id, qty){
    const key = String(id);
    if (qty <= 0) delete cart[key];
    else cart[key] = qty;

    renderGrid();
    renderBottom();

    if (currentProduct && String(currentProduct.id) === key) {
      renderProductControls();
    }
  }

  // google drive image resolver
  function driveImg(url){
    if (!url) return "";
    const s = String(url);

    const m = s.match(/drive\.google\.com\/uc\?export=view&id=([^&]+)/);
    if (m && m[1]) return `https://drive.google.com/thumbnail?id=${m[1]}&sz=w2000`;

    const m2 = s.match(/drive\.google\.com\/file\/d\/([^/]+)\//);
    if (m2 && m2[1]) return `https://drive.google.com/thumbnail?id=${m2[1]}&sz=w2000`;

    return s;
  }

  // ====== UI: GRID ======
  function renderGrid(){
    const grid = el("grid");
    grid.innerHTML = "";

    if (!Array.isArray(products) || products.length === 0){
      grid.innerHTML = `
        <div style="grid-column:1/-1; padding:14px; border:1px solid var(--stroke); border-radius:var(--radius); background:rgba(255,255,255,.75); color:var(--muted); font-weight:700; text-transform:lowercase;">
          товаров пока нет
        </div>
      `;
      return;
    }

    products.forEach(p => {
      const id = String(p.id);
      const card = document.createElement("div");
      card.className = "card";

      const thumb = document.createElement("div");
      thumb.className = "thumb";

      const img = document.createElement("img");
      img.src = (p.photos && p.photos[0]) ? driveImg(p.photos[0]) : "";
      img.alt = p.name || "";
      thumb.appendChild(img);

      thumb.addEventListener("click", () => openProduct(id));

      const content = document.createElement("div");
      content.className = "content";

      const title = document.createElement("p");
      title.className = "title";
      title.textContent = (p.name || "").toLowerCase();

      const row = document.createElement("div");
      row.className = "row";

      const price = document.createElement("p");
      price.className = "price";
      price.textContent = fmt(p.price);

      const controls = document.createElement("div");
      const qty = cart[id] || 0;

      if (qty <= 0){
        const btn = document.createElement("button");
        btn.className = "btn primary";
        btn.textContent = "в корзину";
        btn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          setQty(id, 1);
        });
        controls.appendChild(btn);
      } else {
        const box = document.createElement("div");
        box.className = "qty";

        const minus = document.createElement("button");
        minus.textContent = "–";
        minus.addEventListener("click", (ev) => {
          ev.stopPropagation();
          setQty(id, qty-1);
        });

        const n = document.createElement("span");
        n.textContent = qty;

        const plus = document.createElement("button");
        plus.textContent = "+";
        plus.addEventListener("click", (ev) => {
          ev.stopPropagation();
          setQty(id, qty+1);
        });

        box.append(minus, n, plus);
        controls.appendChild(box);
      }

      row.append(price, controls);
      content.append(title, row);

      card.append(thumb, content);
      grid.appendChild(card);
    });
  }

  // ====== UI: PRODUCT MODAL ======
  function openProduct(id){
    const p = products.find(x => String(x.id) === String(id));
    if (!p) return;

    currentProduct = p;
    galleryIndex = 0;

    el("pTitle").textContent = (p.name || "товар").toLowerCase();
    el("pDesc").textContent = p.description || "";
    el("pPrice").textContent = fmt(p.price);

    renderGallery();
    renderProductControls();

    el("productOverlay").classList.add("open");
  }

  function closeProduct(){
    el("productOverlay").classList.remove("open");
  }

  function renderGallery(){
    const photos = (currentProduct && Array.isArray(currentProduct.photos)) ? currentProduct.photos : [];
    const img = el("gImg");
    img.src = driveImg(photos[galleryIndex] || "");
    img.alt = currentProduct?.name ? String(currentProduct.name) : "";

    const dots = el("dots");
    dots.innerHTML = "";
    photos.forEach((_, i) => {
      const d = document.createElement("div");
      d.className = "dot" + (i === galleryIndex ? " on" : "");
      d.addEventListener("click", () => { galleryIndex = i; renderGallery(); });
      dots.appendChild(d);
    });

    // свайп
    let startX = null;
    const gallery = el("gallery");
    gallery.ontouchstart = (ev)=>{ startX = ev.touches[0].clientX; };
    gallery.ontouchend = (ev)=>{
      if (startX === null) return;
      const endX = ev.changedTouches[0].clientX;
      const dx = endX - startX;
      startX = null;

      if (Math.abs(dx) < 40) return;
      const len = photos.length;
      if (!len) return;

      if (dx < 0) galleryIndex = Math.min(len-1, galleryIndex+1);
      else galleryIndex = Math.max(0, galleryIndex-1);

      renderGallery();
    };
  }

  function renderProductControls(){
    const p = currentProduct;
    const box = el("pControls");
    box.innerHTML = "";
    if (!p) return;

    const id = String(p.id);
    const qty = cart[id] || 0;

    if (qty <= 0){
      const btn = document.createElement("button");
      btn.className = "btn primary";
      btn.textContent = "в корзину";
      btn.addEventListener("click", () => setQty(id, 1));
      box.appendChild(btn);
    } else {
      const q = document.createElement("div");
      q.className = "qty";

      const minus = document.createElement("button");
      minus.textContent = "–";
      minus.addEventListener("click", () => setQty(id, qty-1));

      const n = document.createElement("span");
      n.textContent = qty;

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.addEventListener("click", () => setQty(id, qty+1));

      q.append(minus, n, plus);
      box.appendChild(q);
    }
  }

  // ====== CART / CHECKOUT ======
  function openCart(){
    renderCart();
    el("cartOverlay").classList.add("open");
  }
  function closeCart(){
    el("cartOverlay").classList.remove("open");
  }

  function renderCart(){
    const items = cartItems();
    const root = el("cartItems");
    root.innerHTML = "";

    if (items.length === 0){
      root.innerHTML = `<div style="color:var(--muted);font-size:13px;font-weight:700;text-transform:lowercase;">корзина пустая</div>`;
      el("summary").innerHTML = "";
      return;
    }

    items.forEach(it => {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.gap = "10px";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.padding = "10px 0";
      row.style.borderBottom = "1px solid var(--stroke)";

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";
      left.style.gap = "4px";

      const nm = document.createElement("div");
      nm.style.fontWeight = "900";
      nm.style.fontSize = "13px";
      nm.style.textTransform = "lowercase";
      nm.textContent = (it.name || "").toLowerCase();

      const pr = document.createElement("div");
      pr.style.color = "var(--muted)";
      pr.style.fontSize = "12px";
      pr.style.fontWeight = "700";
      pr.style.textTransform = "lowercase";
      pr.textContent = `${fmt(it.price)} × ${it.qty}`;

      left.append(nm, pr);

      const q = document.createElement("div");
      q.className = "qty";

      const minus = document.createElement("button");
      minus.textContent = "–";
      minus.addEventListener("click", () => { setQty(it.id, it.qty-1); renderCart(); });

      const n = document.createElement("span");
      n.textContent = it.qty;

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.addEventListener("click", () => { setQty(it.id, it.qty+1); renderCart(); });

      q.append(minus, n, plus);

      row.append(left, q);
      root.appendChild(row);
    });

    renderSummary();
  }

  function renderTimeSlots(){
    const dateISO = el("date").value || todayISO();
    const slots = availableSlotsForDate(dateISO);

    const select = el("timeSlot");
    select.innerHTML = "";

    if (slots.length === 0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "на выбранную дату слотов нет";
      select.appendChild(opt);
      select.disabled = true;
      return;
    }

    select.disabled = false;
    slots.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      select.appendChild(opt);
    });
  }

  function renderSummary(){
    const sub = cartSubtotal();
    const dType = el("deliveryType").value;
    const dCost = deliveryCost();

    const lines = [];
    lines.push(`<div class="line"><span>товары</span><span>${fmt(sub)}</span></div>`);

    if (dType === "mkad"){
      lines.push(`<div class="line"><span>доставка</span><span>${fmt(dCost)}</span></div>`);
      lines.push(`<div class="line total"><span>итого</span><span>${fmt(sub + dCost)}</span></div>`);
    } else if (dType === "pickup"){
      lines.push(`<div class="line"><span>самовывоз</span><span>${fmt(0)}</span></div>`);
      lines.push(`<div class="line"><span>адрес</span><span>Автозаводская 23с2</span></div>`);
      lines.push(`<div class="line total"><span>итого</span><span>${fmt(sub)}</span></div>`);
    } else {
      lines.push(`<div class="line"><span>доставка</span><span>уточним</span></div>`);
      lines.push(`<div class="line total"><span>итого</span><span>${fmt(sub)}</span></div>`);
    }

    el("summary").innerHTML = lines.join("");
  }

  function syncRecipientIfSame(){
    if (!el("sameAsCustomer").checked) return;
    el("recipientName").value = el("customerName").value.trim();
    el("recipientPhone").value = el("customerPhone").value.trim();
  }

  async function submitOrder(){
    const items = cartItems();
    if (items.length === 0){
      alert("корзина пустая");
      return;
    }

    const customer_name = el("customerName").value.trim();
    const customer_phone = el("customerPhone").value.trim();

    const delivery_type = el("deliveryType").value;

    const address = el("address").value.trim();
    const date = el("date").value;
    const time_slot = el("timeSlot").value;

    const same = el("sameAsCustomer").checked;
    const recipient_name = same ? customer_name : el("recipientName").value.trim();
    const recipient_phone = same ? customer_phone : el("recipientPhone").value.trim();

    const mustHaveAddress = (delivery_type !== "pickup");

    if (!customer_name || !customer_phone || !recipient_name || !recipient_phone || (mustHaveAddress && !address) || !date || !time_slot){
      alert("проверь поля: заказчик, получатель, дата и интервал" + (mustHaveAddress ? ", адрес" : ""));
      return;
    }

    // проверка слотов (и для динамики, и для фиксированных)
    const slots = availableSlotsForDate(date);
    if (!slots.includes(time_slot)){
      alert("этот интервал уже недоступен. выбери другой.");
      renderTimeSlots();
      return;
    }

    const delivery_price = (delivery_type === "mkad") ? DELIVERY_MKAD : (delivery_type === "pickup" ? 0 : "уточним");

    let finalAddress = address;
    if (delivery_type === "pickup"){
      finalAddress = "Самовывоз: Автозаводская 23с2";
    }

    const payload = {
      action: "create_order",
      tg_user_id: 0,
      tg_username: "",
      customer_name,
      customer_phone,
      recipient_name,
      recipient_phone,
      same_as_customer: same,
      address: finalAddress,
      date,
      time_slot,
      delivery_type,
      delivery_price,
      total: (delivery_type === "mkad") ? (cartSubtotal() + DELIVERY_MKAD) : cartSubtotal(),
      items: items.map(it => ({ id: it.id, name: it.name, qty: it.qty, price: it.price })),
      comment: el("comment").value.trim()
    };

    // Telegram WebApp context
    try{
      if (window.Telegram && window.Telegram.WebApp){
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand?.();
        const u = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
        if (u){
          payload.tg_user_id = u.id || 0;
          payload.tg_username = u.username || "";
        }
      }
    } catch(_) {}

    el("submitOrder").disabled = true;
    el("submitOrder").textContent = "отправляем…";

    try{
      const res = await fetch(API_BASE, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      if (!res.ok) throw new Error(text);

      cart = {};
      renderBottom();
      renderGrid();
      closeCart();
      closeProduct();

      alert("заказ отправлен. мы свяжемся для подтверждения и оплаты.");
    } catch(err){
      console.error(err);
      alert("не удалось отправить заказ. попробуй ещё раз или напиши нам в telegram.");
    } finally{
      el("submitOrder").disabled = false;
      el("submitOrder").textContent = "отправить заказ";
    }
  }

  // ====== INIT ======
  async function loadProducts(){
    const url = `${API_BASE}?action=products`;
    const res = await fetch(url, { method:"GET", cache:"no-store" });

    if (!res.ok){
      throw new Error(`GET products: HTTP ${res.status}`);
    }

    const json = await res.json();
    const arr = Array.isArray(json) ? json : (json && Array.isArray(json.products) ? json.products : []);

    products = arr.map((p, i) => ({
      id: (p.id ?? p.sku ?? p.code ?? i).toString(),
      name: p.name ?? p.title ?? "без названия",
      price: Number(p.price ?? p.cost ?? 0) || 0,
      description: p.description ?? p.desc ?? "",
      photos: Array.isArray(p.photos) ? p.photos : (Array.isArray(p.images) ? p.images : [])
    }));
  }

  function initForm(){
    el("date").value = todayISO();
    renderTimeSlots();

    el("date").addEventListener("change", () => {
      renderTimeSlots();
    });

    el("deliveryType").addEventListener("change", () => {
      const t = el("deliveryType").value;

      // если pickup — адрес не нужен
      if (t === "pickup"){
        el("address").value = "";
        el("address").disabled = true;
        el("address").placeholder = "самовывоз: Автозаводская 23с2";
      } else {
        el("address").disabled = false;
        el("address").placeholder = "город, улица, дом, подъезд, квартира";
      }

      renderSummary();
      renderBottom();
    });

    el("sameAsCustomer").addEventListener("change", () => {
      const same = el("sameAsCustomer").checked;
      el("recipientFields").style.display = same ? "none" : "grid";
      if (same) syncRecipientIfSame();
    });

    el("customerName").addEventListener("input", syncRecipientIfSame);
    el("customerPhone").addEventListener("input", syncRecipientIfSame);

    el("recipientFields").style.display = "grid";
    renderSummary();
  }

  function initUI(){
    el("openCartBtn").addEventListener("click", openCart);
    el("checkoutBtn").addEventListener("click", openCart);

    el("closeCart").addEventListener("click", closeCart);
    el("closeProduct").addEventListener("click", closeProduct);

    el("cartOverlay").addEventListener("click", (e) => {
      if (e.target === el("cartOverlay")) closeCart();
    });
    el("productOverlay").addEventListener("click", (e) => {
      if (e.target === el("productOverlay")) closeProduct();
    });

    el("goCheckoutFromProduct").addEventListener("click", () => {
      closeProduct();
      openCart();
    });

    el("submitOrder").addEventListener("click", submitOrder);
  }

  async function boot(){
    initUI();
    initForm();

    try{
      const tg = window.Telegram?.WebApp;
      if (tg){
        tg.ready();
        tg.expand?.();
      }
    } catch(_) {}

    try{
      el("grid").innerHTML = `
        <div style="grid-column:1/-1; padding:14px; border:1px solid var(--stroke); border-radius:var(--radius); background:rgba(255,255,255,.75); color:var(--muted); font-weight:700; text-transform:lowercase;">
          загружаем товары…
        </div>
      `;

      await loadProducts();
      renderGrid();
      renderBottom();
    } catch (err){
      console.error(err);
      el("grid").innerHTML = `
        <div style="grid-column:1/-1; padding:14px; border:1px solid var(--stroke); border-radius:var(--radius); background:rgba(255,255,255,.75); color:var(--muted); font-weight:700; text-transform:lowercase;">
          не удалось загрузить каталог: <span style="color:var(--text); font-weight:900;">${String(err?.message || "ошибка")}</span>
        </div>
      `;
    }
  }

  document.addEventListener("DOMContentLoaded", boot);
</script>

</body>
</html>
