<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="format-detection" content="telephone=no" />
  <title>дарицветы.москва</title>
  <style>
    :root{
      --wine:#78020e;
      --wine2:#5f010b;
      --bg:#ffffff;
      --card:#ffffff;
      --text:#141418;
      --muted:#6b7280;
      --stroke:rgba(17,24,39,.10);
      --shadow: 0 10px 28px rgba(17,24,39,.08);
      --radius:18px;

      /* telegram bridges */
      --tg-bg: var(--tg-theme-bg-color, var(--bg));
      --tg-text: var(--tg-theme-text-color, var(--text));
      --tg-hint: var(--tg-theme-hint-color, var(--muted));
      --tg-card: var(--tg-theme-secondary-bg-color, var(--card));
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "SF Pro Text", "Segoe UI", Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: linear-gradient(180deg, rgba(207,232,255,.18), var(--tg-bg) 260px);
      color: var(--tg-text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    *{box-sizing:border-box;}
    a{color:inherit}
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 96px;}
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px; margin:10px 0 16px;
    }
    .brand{
      display:flex; flex-direction:column; gap:6px;
    }
    .brand .name{font-size:30px; font-weight:750; letter-spacing:-.02em; color:var(--wine);}
    .brand .sub{font-size:14px; color:var(--tg-hint); letter-spacing:.02em;}
    .pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      background: color-mix(in srgb, var(--tg-card) 82%, transparent);
      border:1px solid var(--stroke);
      border-radius:999px;
      box-shadow: 0 6px 18px rgba(17,24,39,.05);
      user-select:none;
    }
    .pill b{font-weight:750;}
    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:12px 14px; border-radius:999px;
      background: var(--wine);
      color:#fff;
      font-weight:750;
      box-shadow: 0 10px 22px rgba(120,2,14,.18);
    }
    .btn:active{transform:translateY(1px);}
    .btn.secondary{
      background: color-mix(in srgb, var(--tg-card) 92%, transparent);
      color: var(--tg-text);
      border:1px solid var(--stroke);
      box-shadow:none;
    }
    .btn.full{width:100%;}
    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin: 8px 0 18px;
    }
    select, input, textarea{
      font: inherit;
      font-size:16px; /* anti iOS zoom */
      color: var(--tg-text);
      background: color-mix(in srgb, var(--tg-card) 92%, transparent);
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:12px 12px;
      outline:none;
    }
    textarea{min-height:96px; resize:vertical;}
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (min-width: 760px){
      .grid{grid-template-columns: repeat(3, minmax(0, 1fr)); gap:14px;}
    }
    .card{
      background: color-mix(in srgb, var(--tg-card) 94%, transparent);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      cursor:pointer;
      display:flex; flex-direction:column;
      min-height: 240px;
    }
    .img{
      width:100%; aspect-ratio: 1 / 1;
      background: rgba(17,24,39,.04);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .img img{width:100%; height:100%; object-fit:cover; display:block;}
    .card .body{padding:12px 12px 12px; display:flex; flex-direction:column; gap:8px; flex:1;}
    .title{font-weight:750; letter-spacing:-.01em; line-height:1.2;}
    .meta{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:auto;}
    .price{font-weight:800;}
    .muted{color:var(--tg-hint); font-size:13px; line-height:1.3;}

    .bottom{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 12px 12px;
      background: color-mix(in srgb, var(--tg-bg) 85%, transparent);
      backdrop-filter: blur(14px);
      border-top:1px solid var(--stroke);
    }
    .bottom .inner{
      max-width:980px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .bottom .sum{color:var(--tg-hint); font-weight:650;}
    .bottom .sum b{color:var(--tg-text);}

    /* modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:flex-end;
      z-index:50;
    }
    .overlay.show{display:flex;}
    .sheet{
      width:100%;
      background: var(--tg-bg);
      border-radius: 22px 22px 0 0;
      border:1px solid var(--stroke);
      max-height: 92vh;
      overflow:auto;
      box-shadow: 0 30px 80px rgba(0,0,0,.25);
    }
    .sheet .pad{padding:14px;}
    .sheet header{
      margin:0;
      padding:14px 14px 0;
    }
    .sheet .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 14px 0;
    }
    .x{
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--tg-card) 92%, transparent);
      border-radius:999px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:750;
    }
    .gallery{
      display:flex; gap:10px; overflow:auto; padding:0 14px 12px;
      scroll-snap-type:x mandatory;
    }
    .gimg{
      flex:0 0 86%;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--stroke);
      background: rgba(17,24,39,.04);
      scroll-snap-align:start;
      aspect-ratio: 1 / 1;
    }
    .gimg img{width:100%; height:100%; object-fit:cover; display:block;}
    .qtyRow{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-top:10px;
    }
    .qty{
      display:flex; align-items:center; gap:8px;
    }
    .qbtn{
      width:40px; height:40px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--tg-card) 92%, transparent);
      font-weight:850;
      cursor:pointer;
    }
    .qnum{
      width:46px; text-align:center; font-weight:800;
    }
    .sectionTitle{
      margin:14px 0 8px;
      font-size:12px;
      color:var(--tg-hint);
      letter-spacing:.12em;
      text-transform:lowercase;
    }
    .line{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 0;
      border-bottom:1px solid color-mix(in srgb, var(--stroke) 75%, transparent);
    }
    .line:last-child{border-bottom:0;}
    .hint{color:var(--tg-hint); font-size:13px; line-height:1.35;}
    .err{color:#b42318; font-weight:650; margin-top:8px; display:none;}
    .success{color:#0f766e; font-weight:650; margin-top:8px; display:none;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="name">дарицветы.москва</div>
        <div class="sub">доставка цветов</div>
      </div>
      <div class="pill" id="cartPill" role="button" aria-label="корзина">
        <span>корзина</span>
        <b id="cartCount">0</b>
      </div>
    </header>

    <div class="toolbar">
      <select id="categoryFilter" aria-label="категория">
        <option value="all">все категории</option>
      </select>
      <button class="btn secondary" id="refreshBtn">обновить</button>
      <span class="muted" id="statusText"></span>
    </div>

    <div class="grid" id="grid"></div>
  </div>

  <div class="bottom">
    <div class="inner">
      <div class="sum">в корзине: <b id="bottomCount">0</b> · итого: <b id="bottomTotal">0 ₽</b></div>
      <button class="btn" id="checkoutBtn">оформить</button>
    </div>
  </div>

  <!-- product / checkout sheet -->
  <div class="overlay" id="overlay">
    <div class="sheet" id="sheet">
      <div class="topbar">
        <button class="x" id="backBtn">назад</button>
        <button class="x" id="closeBtn">закрыть</button>
      </div>
      <div id="sheetBody"></div>
    </div>
  </div>

<script>
(() => {
  // ===== config =====
  const BRAND = "дарицветы.москва";
  const SUPPORT = "@chaiori";
  const WORK_START_MINUTES = 10 * 60;
  const WORK_END_MINUTES = 22 * 60;
  const LEAD_TIME_MINUTES = 180; // 3 часа
  const API_BASE = "https://script.google.com/macros/s/AKfycbzdOFj8B64mrN1q_cmdhjOkvG4KsgZZP-6b2lpfdXBQ2-JUz3juEYcr76iPrvp5lGEhbA/exec";

  // ===== state =====
  let products = [];
  let filtered = [];
  let categories = [];
  let activeProduct = null;
  let view = "grid"; // grid | product | checkout | cart
  const cart = loadCart(); // {id: {id, qty, price, name}}

  // ===== helpers =====
  const el = (id) => document.getElementById(id);
  const fmt = (n) => `${Math.round(Number(n)||0).toLocaleString("ru-RU")} ₽`;
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const toISODate = (d) => {
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  };
  const fmtTime = (mins) => {
    const h = Math.floor(mins/60);
    const m = mins%60;
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
  };
  const safeJsonParse = (s) => { try{ return JSON.parse(s); }catch(_){ return null; } };

  function getTelegramContext(){
    try{
      const tg = window.Telegram?.WebApp;
      const user = tg?.initDataUnsafe?.user || null;
      return { tg, user, initData: tg?.initData || "" };
    }catch(_){ return { tg:null, user:null, initData:"" }; }
  }

  function applyTelegramTheme(){
    try{
      const tg = window.Telegram?.WebApp;
      if (!tg) return;
      const tp = tg.themeParams || {};
      if (tp.bg_color) document.documentElement.style.setProperty("--tg-theme-bg-color", tp.bg_color);
      if (tp.text_color) document.documentElement.style.setProperty("--tg-theme-text-color", tp.text_color);
      if (tp.hint_color) document.documentElement.style.setProperty("--tg-theme-hint-color", tp.hint_color);
      if (tp.secondary_bg_color) document.documentElement.style.setProperty("--tg-theme-secondary-bg-color", tp.secondary_bg_color);
      const isDark = tg.colorScheme === "dark";
      if (isDark){
        document.documentElement.style.setProperty("--stroke", "rgba(255,255,255,.12)");
      } else {
        document.documentElement.style.setProperty("--stroke", "rgba(17,24,39,.10)");
      }
    }catch(_){}
  }

  // ===== cart =====
  function loadCart(){
    try{
      const raw = localStorage.getItem("daricvety_cart");
      const obj = raw ? JSON.parse(raw) : {};
      return (obj && typeof obj === "object") ? obj : {};
    }catch(_){ return {}; }
  }
  function saveCart(){ localStorage.setItem("daricvety_cart", JSON.stringify(cart)); }
  function cartCount(){
    return Object.values(cart).reduce((s,it)=>s + (Number(it.qty)||0), 0);
  }
  function cartSubtotal(){
    return Object.values(cart).reduce((s,it)=>s + (Number(it.price)||0)*(Number(it.qty)||0), 0);
  }
  function setQty(id, qty){
    qty = Math.max(0, Math.floor(Number(qty)||0));
    if (qty <= 0) delete cart[id];
    else {
      const p = products.find(x=>x.id===id);
      if (!p) return;
      cart[id] = { id, qty, price: Number(p.price)||0, name: p.name };
    }
    saveCart();
    updateBottom();
  }

  function updateBottom(){
    el("cartCount").textContent = String(cartCount());
    el("bottomCount").textContent = String(cartCount());
    el("bottomTotal").textContent = fmt(cartSubtotal());
  }

  // ===== data =====
  async function fetchProducts(){
    el("statusText").textContent = "загрузка каталога…";
    try{
      const res = await fetch(API_BASE + "?action=products", { method:"GET" });
      const raw = await res.text();
      const json = safeJsonParse(raw);
      if (!res.ok) throw new Error(raw || ("http " + res.status));
      if (!json || json.status !== "ok" || !Array.isArray(json.products)) {
        throw new Error("неожиданный ответ api");
      }
      products = json.products.map(p => ({
        id: String(p.id||"").trim(),
        name: String(p.name||"").trim(),
        category: String(p.category||"").trim(),
        price: Number(p.price)||0,
        photos: Array.isArray(p.photos) ? p.photos.filter(Boolean) : [],
        description: String(p.description||"").trim(),
        sort: Number(p.sort)||0
      })).filter(p => p.id && p.name);

      // categories
      const set = new Set(products.map(p => p.category).filter(Boolean));
      categories = Array.from(set).sort((a,b)=>a.localeCompare(b));
      rebuildCategoryFilter();

      applyFilter();
      el("statusText").textContent = products.length ? "" : "товаров пока нет";
    }catch(err){
      console.log("products error:", err);
      el("statusText").textContent = "не удалось загрузить каталог";
      products = [];
      filtered = [];
      renderGrid();
    }
  }

  function rebuildCategoryFilter(){
    const sel = el("categoryFilter");
    const current = sel.value || "all";
    sel.innerHTML = `<option value="all">все категории</option>` + categories.map(c => `<option value="${escapeHtmlAttr(c)}">${escapeHtml(c)}</option>`).join("");
    sel.value = categories.includes(current) ? current : "all";
  }

  function applyFilter(){
    const cat = el("categoryFilter").value;
    filtered = products.filter(p => cat === "all" ? true : p.category === cat)
      .sort((a,b)=>(a.sort||0)-(b.sort||0));
    renderGrid();
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
  function escapeHtmlAttr(s){
    return escapeHtml(String(s ?? "")).replace(/"/g,"&quot;");
  }

  function renderGrid(){
    const g = el("grid");
    if (!filtered.length){
      g.innerHTML = `<div class="muted" style="grid-column:1/-1;padding:10px 2px;">ничего не найдено</div>`;
      return;
    }
    g.innerHTML = filtered.map(p => {
      const img = p.photos && p.photos[0] ? `<img src="${escapeHtmlAttr(p.photos[0])}" alt="${escapeHtmlAttr(p.name)}" loading="lazy">` : "";
      return `
        <div class="card" data-id="${escapeHtmlAttr(p.id)}" role="button" tabindex="0">
          <div class="img">${img}</div>
          <div class="body">
            <div class="title">${escapeHtml(p.name)}</div>
            <div class="meta">
              <div class="price">${fmt(p.price)}</div>
              <button class="btn secondary" data-add="${escapeHtmlAttr(p.id)}" style="padding:10px 12px;">в корзину</button>
            </div>
          </div>
        </div>`;
    }).join("");

    // click handlers
    g.querySelectorAll("[data-add]").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const id = btn.getAttribute("data-add");
        const cur = cart[id]?.qty || 0;
        setQty(id, cur + 1);
      });
    });
    g.querySelectorAll(".card").forEach(card=>{
      card.addEventListener("click", ()=>{
        const id = card.getAttribute("data-id");
        openProduct(id);
      });
      card.addEventListener("keydown", (e)=>{
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          const id = card.getAttribute("data-id");
          openProduct(id);
        }
      });
    });
  }

  // ===== overlay views =====
  function openOverlay(){
    el("overlay").classList.add("show");
    // Telegram: expand
    try{ window.Telegram?.WebApp?.expand?.(); }catch(_){}
  }
  function closeOverlay(){
    el("overlay").classList.remove("show");
    activeProduct = null;
    view = "grid";
    el("sheetBody").innerHTML = "";
  }

  function openProduct(id){
    const p = products.find(x=>x.id===id);
    if (!p) return;
    activeProduct = p;
    view = "product";
    el("backBtn").style.display = "none";
    renderProductSheet();
    openOverlay();
  }

  function openCheckout(){
    view = "checkout";
    el("backBtn").style.display = "inline-block";
    renderCheckoutSheet();
    openOverlay();
  }

  function openCart(){
    view = "cart";
    el("backBtn").style.display = "none";
    renderCartSheet();
    openOverlay();
  }

  function renderProductSheet(){
    const p = activeProduct;
    const qty = cart[p.id]?.qty || 0;
    const photos = (p.photos && p.photos.length) ? p.photos : [];
    const gallery = photos.length ? `
      <div class="gallery">
        ${photos.map(url => `<div class="gimg"><img src="${escapeHtmlAttr(url)}" alt="" loading="lazy"></div>`).join("")}
      </div>` : `<div class="pad"><div class="muted">фото скоро появятся</div></div>`;

    el("sheetBody").innerHTML = `
      <header>
        <div class="brand">
          <div class="name" style="font-size:20px;color:var(--tg-text);">${escapeHtml(p.name)}</div>
          <div class="sub">${fmt(p.price)}</div>
        </div>
      </header>
      ${gallery}
      <div class="pad">
        <div class="muted">${escapeHtml(p.description || "")}</div>
        <div class="qtyRow">
          <div class="price" style="font-size:18px;">${fmt(p.price)}</div>
          <div class="qty">
            <button class="qbtn" id="minusBtn">−</button>
            <div class="qnum" id="qtyNum">${qty}</div>
            <button class="qbtn" id="plusBtn">+</button>
          </div>
        </div>
        <div style="margin-top:12px;">
          <button class="btn full" id="goCheckout">оформить</button>
        </div>
      </div>
    `;

    el("minusBtn").onclick = ()=> setQty(p.id, (cart[p.id]?.qty||0) - 1);
    el("plusBtn").onclick = ()=> setQty(p.id, (cart[p.id]?.qty||0) + 1);
    el("goCheckout").onclick = ()=>{
      if (cartCount() <= 0){
        setQty(p.id, 1);
      }
      openCheckout();
    };

    // update qty live
    const observer = new MutationObserver(()=>{});
    // simple periodic update
    const tick = () => {
      if (view !== "product" || !activeProduct || activeProduct.id !== p.id) return;
      const q = cart[p.id]?.qty || 0;
      const qn = document.getElementById("qtyNum");
      if (qn) qn.textContent = String(q);
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  }

  function renderCartSheet(){
    const items = Object.values(cart);
    const lines = items.length ? items.map(it => {
      const p = products.find(x=>x.id===it.id);
      const name = p ? p.name : it.name;
      const price = p ? Number(p.price)||0 : Number(it.price)||0;
      const qty = Number(it.qty)||0;
      return `
        <div class="line">
          <div style="min-width:0">
            <div style="font-weight:750; line-height:1.2;">${escapeHtml(name)}</div>
            <div class="muted">${fmt(price)} · ${qty} шт</div>
          </div>
          <div style="display:flex; align-items:center; gap:8px;">
            <button class="qbtn" data-m="${escapeHtmlAttr(it.id)}">−</button>
            <div style="width:32px;text-align:center;font-weight:800;">${qty}</div>
            <button class="qbtn" data-p="${escapeHtmlAttr(it.id)}">+</button>
          </div>
        </div>`;
    }).join("") : `<div class="muted">корзина пустая</div>`;

    el("sheetBody").innerHTML = `
      <div class="pad">
        <div class="sectionTitle">корзина</div>
        ${lines}
        <div class="sectionTitle">итоги</div>
        <div class="line"><span>товары</span><span>${fmt(cartSubtotal())}</span></div>
        <div style="margin-top:12px;">
          <button class="btn full" id="cartCheckout" ${items.length? "" : "disabled"}>оформить</button>
        </div>
      </div>
    `;

    el("sheetBody").querySelectorAll("[data-m]").forEach(b=>{
      b.onclick = ()=> setQty(b.getAttribute("data-m"), (cart[b.getAttribute("data-m")]?.qty||0)-1);
    });
    el("sheetBody").querySelectorAll("[data-p]").forEach(b=>{
      b.onclick = ()=> setQty(b.getAttribute("data-p"), (cart[b.getAttribute("data-p")]?.qty||0)+1);
    });
    el("cartCheckout").onclick = ()=> openCheckout();
  }

  // ===== delivery & checkout =====
  function buildSlots(dateStr){
    const now = new Date();
    const todayStr = toISODate(now);
    const isToday = dateStr === todayStr;

    const blocks = [
      [WORK_START_MINUTES, WORK_START_MINUTES + 240],       // 10-14
      [WORK_START_MINUTES + 240, WORK_START_MINUTES + 480], // 14-18
      [WORK_START_MINUTES + 480, WORK_END_MINUTES]          // 18-22
    ];

    if (!isToday){
      return blocks.map(([s,e]) => ({ start:s, end:e, label:`${fmtTime(s)}–${fmtTime(e)}` }));
    }

    const curMin = now.getHours()*60 + now.getMinutes();
    const earliest = curMin + LEAD_TIME_MINUTES;

    return blocks
      .filter(([s,e]) => e > curMin && earliest <= e)
      .map(([s,e]) => ({ start:s, end:e, label:`${fmtTime(s)}–${fmtTime(e)}` }));
  }

  async function loadBonus(){
    const ctx = getTelegramContext();
    const uid = ctx.user?.id ? Number(ctx.user.id) : 0;
    if (!uid && !ctx.initData) return 0;

    try{
      const payload = { action:"get_bonus", tg_user_id: uid || 0, tg_init_data: ctx.initData || "" };
      const res = await fetch(API_BASE, {
        method:"POST",
        headers: { "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      const raw = await res.text();
      const json = safeJsonParse(raw);
      if (res.ok && json && json.status === "ok") return Number(json.balance)||0;
    }catch(_){}
    return 0;
  }

  function maskPhone(v){
    const digits = String(v||"").replace(/\D/g,"").slice(0, 11);
    let d = digits;
    if (d.startsWith("8")) d = "7" + d.slice(1);
    if (!d.startsWith("7")) d = "7" + d;
    const p = d.slice(1);
    const a = p.slice(0,3), b=p.slice(3,6), c=p.slice(6,8), e=p.slice(8,10);
    let out = "+7";
    if (a) out += " (" + a;
    if (a && a.length===3) out += ")";
    if (b) out += " " + b;
    if (c) out += "-" + c;
    if (e) out += "-" + e;
    return out;
  }

  function normalizePhone(v){
    const d = String(v||"").replace(/\D/g,"");
    if (!d) return "";
    if (d.startsWith("8")) return "7" + d.slice(1);
    if (d.startsWith("7")) return d;
    return "7" + d;
  }

  function renderCheckoutSheet(){
    const items = Object.values(cart);
    if (!items.length){
      el("sheetBody").innerHTML = `<div class="pad"><div class="muted">корзина пустая</div></div>`;
      return;
    }

    el("backBtn").onclick = () => openCart();

    const todayStr = toISODate(new Date());
    const subtotal = cartSubtotal();

    el("sheetBody").innerHTML = `
      <div class="pad">
        <div class="sectionTitle">оформление</div>

        <div class="sectionTitle">контакты</div>
        <input id="customerName" placeholder="ваше имя" autocomplete="name" />
        <div style="height:10px"></div>
        <input id="customerPhone" placeholder="телефон" inputmode="tel" autocomplete="tel" />

        <div class="sectionTitle">доставка</div>
        <select id="deliveryType">
          <option value="mkad">в пределах мкад (650 ₽)</option>
          <option value="pickup">самовывоз (автозаводская 23с2)</option>
          <option value="outside">за мкад — уточним</option>
        </select>

        <div style="height:10px"></div>
        <input id="address" placeholder="адрес" autocomplete="street-address" />
        <div style="height:10px"></div>
        <label style="display:flex; gap:10px; align-items:flex-start; font-size:14px; color:var(--tg-hint);">
          <input id="clarify" type="checkbox" />
          <span>уточнить адрес у получателя</span>
        </label>

        <div class="sectionTitle">дата и интервал</div>
        <input id="date" type="date" />
        <div style="height:10px"></div>
        <select id="slot"></select>
        <div class="hint" id="slotHint"></div>

        <div class="sectionTitle">бонусы</div>
        <div class="line"><span>баланс</span><span><b id="bonusBalance">—</b></span></div>
        <div class="line" style="gap:10px;">
          <span>списать</span>
          <input id="bonusSpend" type="number" min="0" step="1" inputmode="numeric" placeholder="0" style="width:140px;text-align:right;" />
        </div>
        <div class="hint">можно списать при покупке (только на товары)</div>

        <div class="sectionTitle">комментарий</div>
        <textarea id="comment" placeholder="например: позвонить за 10 минут до приезда"></textarea>

        <div class="sectionTitle">персональные данные</div>
        <label style="display:flex; gap:10px; align-items:flex-start; font-size:14px; line-height:1.35;">
          <input id="pd" type="checkbox" />
          <span>даю согласие на обработку персональных данных. поддержка: 9:00–21:00 мск (${SUPPORT}).</span>
        </label>

        <div class="sectionTitle">итоги</div>
        <div class="line"><span>товары</span><span id="sumGoods">${fmt(subtotal)}</span></div>
        <div class="line"><span>доставка</span><span id="sumDelivery">0 ₽</span></div>
        <div class="line"><span>бонусы</span><span id="sumBonus">0 ₽</span></div>
        <div class="line" style="font-weight:850;"><span>итого</span><span id="sumTotal">${fmt(subtotal)}</span></div>

        <div class="err" id="err"></div>
        <div class="success" id="ok"></div>

        <div style="height:12px"></div>
        <button class="btn full" id="submit">оформить заказ</button>
      </div>
    `;

    const dateEl = document.getElementById("date");
    dateEl.min = todayStr;
    dateEl.value = todayStr;

    const phoneEl = document.getElementById("customerPhone");
    phoneEl.addEventListener("input", ()=> {
      const cur = phoneEl.value;
      phoneEl.value = maskPhone(cur);
    });

    const deliveryEl = document.getElementById("deliveryType");
    const addressEl = document.getElementById("address");
    const slotEl = document.getElementById("slot");
    const slotHint = document.getElementById("slotHint");

    function deliveryCost(){
      const t = deliveryEl.value;
      if (t === "mkad") return 650;
      if (t === "pickup") return 0;
      return 0;
    }

    function refreshSlots(){
      const d = dateEl.value || todayStr;
      // protect past dates
      if (d < todayStr) dateEl.value = todayStr;

      const slots = buildSlots(dateEl.value);
      slotEl.innerHTML = slots.length
        ? slots.map(s=>`<option value="${escapeHtmlAttr(s.label)}">${escapeHtml(s.label)}</option>`).join("")
        : `<option value="">на сегодня нет свободных интервалов — выберите другую дату</option>`;

      slotEl.value = slots[0]?.label || "";
      slotHint.textContent = (d === todayStr)
        ? "на сегодня доступны только интервалы, в которые успеем с учётом подготовки (минимум 3 часа)."
        : "рабочие интервалы: 10–14, 14–18, 18–22.";
      recalc();
    }

    let bonusBalance = 0;

    async function initBonus(){
      bonusBalance = await loadBonus();
      document.getElementById("bonusBalance").textContent = String(bonusBalance) + " ₽";
      recalc();
    }

    function recalc(){
      const goods = subtotal;
      const del = deliveryCost();
      const maxSpend = Math.max(0, Math.min(goods, bonusBalance));
      const spendEl = document.getElementById("bonusSpend");
      let spend = Math.floor(Number(spendEl.value || 0) || 0);
      spend = clamp(spend, 0, maxSpend);
      if (String(spend) !== String(Math.floor(Number(spendEl.value||0)||0))) {
        spendEl.value = spend ? String(spend) : "";
      }
      document.getElementById("sumDelivery").textContent = fmt(del);
      document.getElementById("sumBonus").textContent = spend ? ("- " + fmt(spend)) : "0 ₽";
      document.getElementById("sumTotal").textContent = fmt(goods + del - spend);

      // address enabled/disabled
      if (deliveryEl.value === "pickup") {
        addressEl.value = "самовывоз: автозаводская 23с2";
        addressEl.disabled = true;
      } else {
        if (addressEl.disabled) addressEl.value = "";
        addressEl.disabled = false;
      }
    }

    dateEl.addEventListener("change", refreshSlots);
    deliveryEl.addEventListener("change", ()=>{ recalc(); });
    document.getElementById("bonusSpend").addEventListener("input", recalc);

    refreshSlots();
    initBonus();

    document.getElementById("submit").addEventListener("click", submitOrder);

    async function submitOrder(){
      const err = document.getElementById("err");
      const ok = document.getElementById("ok");
      err.style.display = "none"; ok.style.display = "none";

      const name = (document.getElementById("customerName").value || "").trim();
      const phone = normalizePhone(document.getElementById("customerPhone").value || "");
      const date = dateEl.value || todayStr;
      const slot = slotEl.value || "";
      const delivery_type = deliveryEl.value;

      if (!document.getElementById("pd").checked){
        err.textContent = "нужно согласие на обработку персональных данных";
        err.style.display = "block";
        return;
      }
      if (!name || phone.length < 11){
        err.textContent = "проверьте имя и телефон";
        err.style.display = "block";
        return;
      }
      if (!date || !slot){
        err.textContent = "выберите дату и интервал";
        err.style.display = "block";
        return;
      }
      if (delivery_type !== "pickup"){
        const addr = (addressEl.value || "").trim();
        if (!addr){
          err.textContent = "укажите адрес доставки";
          err.style.display = "block";
          return;
        }
      }

      const goods = subtotal;
      const del = deliveryCost();
      const spend = Math.floor(Number(document.getElementById("bonusSpend").value || 0) || 0);
      const maxSpend = Math.max(0, Math.min(goods, bonusBalance));
      const spendAllowed = clamp(spend, 0, maxSpend);

      const ctx = getTelegramContext();
      const payload = {
        action: "create_order",
        tg_user_id: ctx.user?.id || 0,
        tg_username: ctx.user?.username ? ("@" + ctx.user.username) : "",
        tg_first_name: ctx.user?.first_name || "",
        tg_last_name: ctx.user?.last_name || "",
        tg_init_data: ctx.initData || "",

        customer_name: name,
        customer_phone: phone,

        address: (addressEl.value || "").trim(),
        clarify_address_with_recipient: !!document.getElementById("clarify").checked,

        date: date,
        time_slot: slot,

        delivery_type: delivery_type,
        delivery_price: del,

        items: Object.values(cart).map(it => ({
          id: it.id,
          name: it.name,
          price: Number(it.price)||0,
          qty: Number(it.qty)||0
        })),

        subtotal: goods,
        bonus_to_spend: spendAllowed,
        bonus_to_spend_allowed: spendAllowed,
        pd_consent: true,
        comment: (document.getElementById("comment").value || "").trim(),

        total: goods + del
      };

      try{
        const res = await fetch(API_BASE, {
          method:"POST",
          headers: { "Content-Type":"text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });
        const raw = await res.text();
        const json = safeJsonParse(raw);
        if (!res.ok || !json || json.status !== "ok"){
          throw new Error(raw || "ошибка отправки");
        }
        const id = String(json.order_id || "").slice(-4) || "";
        ok.textContent = id ? `заказ отправлен. номер: ${id}` : "заказ отправлен.";
        ok.style.display = "block";

        // clear cart
        for (const k of Object.keys(cart)) delete cart[k];
        saveCart();
        updateBottom();
      }catch(e){
        console.log("order error:", e);
        err.textContent = "не удалось отправить заказ. попробуйте ещё раз или напишите в поддержку " + SUPPORT;
        err.style.display = "block";
      }
    }
  }

  // ===== ui wiring =====
  el("categoryFilter").addEventListener("change", applyFilter);
  el("refreshBtn").addEventListener("click", fetchProducts);
  el("checkoutBtn").addEventListener("click", () => {
    if (cartCount() <= 0) {
      el("statusText").textContent = "добавьте товары в корзину";
      return;
    }
    openCheckout();
  });
  el("cartPill").addEventListener("click", openCart);
  el("closeBtn").addEventListener("click", closeOverlay);
  el("backBtn").addEventListener("click", () => {
    if (view === "checkout") openCart();
    else closeOverlay();
  });
  el("overlay").addEventListener("click", (e)=>{
    if (e.target === el("overlay")) closeOverlay();
  });

  // ===== boot =====
  (async function boot(){
    applyTelegramTheme();
    try{
      const tg = window.Telegram?.WebApp;
      tg?.ready?.();
      tg?.expand?.();
      tg?.onEvent?.("themeChanged", applyTelegramTheme);
    }catch(_){}
    updateBottom();
    await fetchProducts();
  })();
})();
</script>
</body>
</html>
