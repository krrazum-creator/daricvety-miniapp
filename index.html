<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <!-- фикс iOS-зума + стабильный viewport -->
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>дарицветы.москва — доставка цветов</title>

  <!-- telegram webapp sdk -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- fonts: base + "изюминка" только для бренда -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&family=Fraunces:opsz,wght@9..144,600;9..144,700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* telegram theme bridge (fallbacks) */
      --tg-bg: var(--tg-theme-bg-color, var(--bg));
      --tg-text: var(--tg-theme-text-color, var(--text));
      --tg-hint: var(--tg-theme-hint-color, var(--muted));
      --tg-card: var(--tg-theme-secondary-bg-color, var(--card));

      /* palette */
      --sky:#CFE8FF;     /* bounty */
      --wine:#78020E;    /* delicious wine */

      /* background "дымка" */
      --bg:#ffffff;
      --bgTint: rgba(207,232,255,.28);

      /* text */
      --text:#1C1C1E;
      --muted:#6B6B73;

      /* surfaces */
      --card:#FFFFFF;

      /* strokes + glass */
      --stroke:rgba(120,2,14,.10);
      --glassBlue: rgba(207,232,255,.55);
      --glassBlueSoft: rgba(207,232,255,.35);

      --primary:var(--wine);
      --primaryActive:#5d010a;

      --secondary:var(--sky);
      --secondaryActive:#bfe0ff;

      --radius:22px;

      /* фикс высоты под telegram webapp */
      --app-h: 100vh;
    }

    *{box-sizing:border-box}
    html, body{
      height:100%;
      margin:0;
      padding:0;
      overflow-x:hidden;
    }
    body{
      font-family:"Manrope",-apple-system,system-ui,"SF Pro Text","SF Pro Display",Segoe UI,Roboto,Arial,sans-serif;
      background: linear-gradient(180deg, var(--bgTint), var(--tg-bg) 260px);
      color:var(--tg-text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height:var(--app-h);
      font-weight:400;
    }

    .wrap{max-width:980px;margin:0 auto;padding:20px 16px 120px}

    header{
      padding:10px 0 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{line-height:1.1}
    .brand .name{
      font-family:"Fraunces","Manrope",serif;
      font-size:22px;
      font-weight:700;
      letter-spacing:.2px;
      color:var(--wine);
      text-transform:lowercase;
    }
    .brand .tag{
      margin-top:6px;
      font-size:13px;
      color:var(--muted);
      font-weight:500;
      text-transform:lowercase;
    }

    .pill{
      border:1px solid rgba(120,2,14,.12);
      background:var(--glassBlueSoft);
      backdrop-filter: blur(12px);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      display:flex;align-items:center;gap:10px;
      align-self:center;
      box-shadow: 0 10px 26px rgba(207,232,255,.18);
    }
    .pill button{
      border:none;background:transparent;color:var(--wine);
      font-weight:600;font-size:13px;cursor:pointer;
      text-transform:lowercase;
    }
    .pill .count{
      min-width:22px;height:22px;border-radius:999px;
      background:var(--sky);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;font-size:12px;
      border:1px solid rgba(120,2,14,.16);
      color:var(--wine);
    }

    /* ===== FILTERS ===== */
    .filters{
      margin-top:6px;
      display:flex;
      gap:8px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding:6px 0 2px;
    }
    .chip{
      border:1px solid var(--stroke);
      background:#fff;
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      text-transform:lowercase;
      cursor:pointer;
      white-space:nowrap;
      color:var(--wine);
    }
    .chip.on{
      background: var(--sky);
      border-color: rgba(120,2,14,.12);
      box-shadow: 0 8px 18px rgba(207,232,255,.35);
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:14px;
      margin-top:12px;
    }
    @media (min-width:760px){
      .grid{grid-template-columns:repeat(3, minmax(0, 1fr));}
      .brand .name{font-size:26px}
    }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:0 10px 26px rgba(0,0,0,.06);
      display:flex;flex-direction:column;
      min-height:260px;
    }

    .thumb{
      width:100%;
      aspect-ratio: 1 / 1;
      background:#f1f1f3;
      position:relative;
      cursor:pointer;
    }
    .thumb img{
      width:100%;height:100%;object-fit:cover;display:block;
    }

    .content{
      padding:12px 12px 14px;
      display:flex;flex-direction:column;gap:10px;flex:1;
    }
    .title{
      font-size:14px;font-weight:600;line-height:1.25;
      margin:0;
      text-transform:lowercase;
    }
    .price{
      font-size:15px;font-weight:700;
      margin:0;
      color:var(--wine);
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}

    .btn{
      border:none;cursor:pointer;
      padding:10px 12px;
      border-radius:16px;
      font-weight:600;font-size:13px;
      text-transform:lowercase;
      user-select:none;
      transition: transform .06s ease;
    }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{ background:var(--primary); color:#fff; }
    .btn.primary:active{ background:var(--primaryActive); }

    .btn.secondary{ background:var(--secondary); color:var(--wine); }
    .btn.secondary:active{ background:var(--secondaryActive); }

    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .qty{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:6px 8px;
      background:rgba(255,255,255,.96);
    }
    .qty button{
      width:32px;height:32px;border-radius:14px;border:none;cursor:pointer;
      background:rgba(120,2,14,.06);
      font-weight:700;font-size:16px;color:var(--wine);
    }
    .qty span{min-width:20px;text-align:center;font-weight:700;color:var(--wine)}

    /* ===== MODAL BASE (скролл) ===== */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.35);
      display:none;
      justify-content:center;
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      align-items:flex-start;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      height:var(--app-h);
    }
    .overlay.open{display:flex}

    .sheet{
      width:min(720px, 100%);
      background:var(--card);
      border-radius:26px;
      border:1px solid var(--stroke);
      box-shadow:0 18px 60px rgba(0,0,0,.18);
      overflow:hidden;
      max-height:calc(var(--app-h) - 20px);
      display:flex;
      flex-direction:column;
      margin:10px 0;
    }
    .sheetHeader{
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid var(--stroke);
      flex:0 0 auto;
      background: rgba(207,232,255,.28);
    }
    .sheetHeader .h{
      font-weight:700;
      letter-spacing:.1px;
      text-transform:lowercase;
      color:var(--wine);
    }
    .iconBtn{
      border:none;background:transparent;cursor:pointer;
      font-size:20px;line-height:1;
      padding:6px 8px;border-radius:12px;
      color:var(--wine);
    }
    .sheetBody{
      padding:14px 16px 18px;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      flex:1 1 auto;
    }

    /* ===== PRODUCT FULLSCREEN ===== */
    #productOverlay.open{ padding:0; }
    #productOverlay .sheet{
      width:100%;
      max-width:100%;
      height:var(--app-h);
      max-height:var(--app-h);
      border-radius:0;
      margin:0;
      border:none;
    }
    #productOverlay .sheetBody{ padding:0; }

    .gallery{
      border-radius:0;
      overflow:hidden;
      border:none;
      background:#000;
      position:relative;
      user-select:none;
    }
    .gallery img{
      width:100%;
      height:65vh;
      object-fit:cover;
      display:block;
    }

    .dots{
      position:absolute;left:0;right:0;bottom:10px;
      display:flex;justify-content:center;gap:6px;
    }
    .dot{
      width:7px;height:7px;border-radius:999px;
      background:rgba(255,255,255,.65);
      border:1px solid rgba(0,0,0,.10);
    }
    .dot.on{background:var(--sky)}

    .desc{
      margin:12px 16px 0;
      color:var(--muted);
      font-size:13px;line-height:1.45;
      padding-bottom:10px;
      font-weight:400;
    }

    .productFooter{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:0 16px 16px;
      flex-wrap:wrap;
    }
    .productFooter .actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .sectionTitle{
      margin:14px 0 8px;
      font-weight:600;
      font-size:13px;
      letter-spacing:.1px;
      text-transform:lowercase;
      color:var(--wine);
    }

    .form{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .field{
      display:flex;flex-direction:column;gap:6px;
    }
    .field label{
      font-size:12px;color:var(--muted);
      font-weight:500;
      text-transform:lowercase;
    }

    /* 16px фиксит авто-zoom на iOS */
    input, select, textarea{
      font-family:inherit;
      font-size:16px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:#fff;
      outline:none;
      font-weight:400;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(120,2,14,.18);
      box-shadow: 0 0 0 4px rgba(207,232,255,.45);
    }
    textarea{min-height:90px;resize:vertical}

    .summary{
      margin-top:12px;
      border:1px solid rgba(120,2,14,.12);
      border-radius:var(--radius);
      padding:12px;
      background: rgba(207,232,255,.35);
      display:flex;flex-direction:column;gap:6px;
      font-size:13px;
    }
    .summary .line{display:flex;justify-content:space-between;gap:10px}
    .summary .total{font-weight:700;font-size:14px;color:var(--wine)}

    .hint{
      margin-top:10px;
      font-size:12px;color:var(--muted);
      text-transform:lowercase;
      font-weight:400;
    }

    .bottomBar{
      position:fixed;left:0;right:0;bottom:0;
      background: var(--glassBlue);
      backdrop-filter: blur(12px);
      border-top:1px solid rgba(120,2,14,.12);
      padding:10px 16px calc(10px + env(safe-area-inset-bottom));
      box-shadow: 0 -10px 26px rgba(207,232,255,.22);
    }
    .bottomInner{
      max-width:980px;margin:0 auto;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
    }
    .bottomInner .mini{
      font-size:13px;color:var(--muted);
      font-weight:500;
      text-transform:lowercase;
    }
    .bottomInner .mini b{color:var(--wine);font-weight:700}

    /* ===== UX OVERLAY (замена alert) ===== */
    .uxOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px 16px calc(18px + env(safe-area-inset-bottom));
      background:rgba(0,0,0,.35);
      z-index:9999;
      height:var(--app-h);
    }
    .uxOverlay.open{display:flex}
    .uxCard{
      width:min(520px, 100%);
      background:#fff;
      border:1px solid var(--stroke);
      border-radius:26px;
      box-shadow:0 18px 60px rgba(0,0,0,.20);
      overflow:hidden;
    }
    .uxCardHeader{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--stroke);
      background: rgba(207,232,255,.28);
    }
    .uxCardHeader .t{
      font-weight:700;
      text-transform:lowercase;
      letter-spacing:.1px;
      color:var(--wine);
    }
    .uxCardBody{
      padding:14px 16px 16px;
    }
    .uxText{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
      font-weight:400;
      text-transform:lowercase;
      white-space:pre-line;
    }
    .uxActions{
      padding:0 16px 16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* loader в кнопке */
    .spinner{
      width:16px;height:16px;
      border-radius:999px;
      border:3px solid rgba(0,0,0,.12);
      border-top-color: rgba(255,255,255,.92);
      display:inline-block;
      animation:spin .8s linear infinite;
      vertical-align:middle;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }

    @media (prefers-reduced-motion: reduce){
      .spinner{ animation:none; }
      .btn{ transition:none; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="name">дарицветы.москва</div>
        <div class="tag">доставка цветов</div>
      </div>
      <div class="pill" title="корзина">
        <button id="openCartBtn">корзина</button>
        <div class="count" id="cartCount">0</div>
      </div>
    </header>

    <div class="filters" id="filters" style="display:none;"></div>
    <div class="grid" id="grid"></div>
  </div>

  <div class="bottomBar" id="bottomBar" style="display:none;">
    <div class="bottomInner">
      <div class="mini">
        в корзине: <b id="bottomCount">0</b> • итого: <b id="bottomTotal">0 ₽</b>
      </div>
      <button class="btn primary" id="checkoutBtn">оформить</button>
    </div>
  </div>

  <!-- product modal -->
  <div class="overlay" id="productOverlay" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHeader">
        <div class="h" id="pTitle">товар</div>
        <button class="iconBtn" id="closeProduct">✕</button>
      </div>

      <div class="sheetBody">
        <div class="gallery" id="gallery">
          <img id="gImg" src="" alt="" />
          <div class="dots" id="dots"></div>
        </div>

        <div class="desc" id="pDesc"></div>

        <div class="productFooter">
          <p class="price" id="pPrice"></p>
          <div class="actions">
            <div id="pControls"></div>
            <button class="btn secondary" id="goCheckoutFromProduct" disabled>перейти к оформлению</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- cart/checkout modal -->
  <div class="overlay" id="cartOverlay" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHeader">
        <div class="h" id="cartTitle">корзина</div>
        <button class="iconBtn" id="closeCart">✕</button>
      </div>
      <div class="sheetBody">
        <div id="cartItems"></div>

        <div class="sectionTitle">доставка</div>
        <div class="form">
          <div class="field">
            <label>тип доставки</label>
            <select id="deliveryType">
              <option value="mkad">москва (в пределах мкад) — 650 ₽</option>
              <option value="pickup">самовывоз — Автозаводская 23с2</option>
              <option value="outside">за мкад — стоимость уточним</option>
            </select>
          </div>

          <div class="field">
            <label>дата</label>
            <input id="date" type="date" />
          </div>

          <div class="field">
            <label>интервал</label>
            <select id="timeSlot"></select>
          </div>

          <div class="field">
            <label>адрес</label>
            <input id="address" type="text" placeholder="пример: город, улица, дом, подъезд, квартира" />
          </div>
          <div class="field">
            <label style="display:flex; align-items:center; gap:10px;">
              <input id="clarifyAddressWithRecipient" type="checkbox" />
              уточнить адрес у получателя
            </label>
          </div>

          <div class="sectionTitle">бонусы</div>
          <div class="summary" id="bonusBox" style="background: rgba(207,232,255,.24);">
            <div class="line"><span>баланс</span><span><b id="bonusBalance">—</b></span></div>
            <div class="line" style="align-items:center;">
              <span>списать</span>
              <span style="display:flex; align-items:center; gap:10px;">
                <input id="bonusToSpend" type="number" min="0" step="1" inputmode="numeric"
                  style="width:140px; text-align:right;" placeholder="0" />
              </span>
            </div>
            <div class="hint" style="margin:6px 0 0;">можно списать при покупке</div>
          </div>
<div class="sectionTitle">открытка</div>

          <div class="field">
            <label style="display:flex; align-items:center; gap:10px;">
              <input id="cardNotNeeded" type="checkbox" />
              открытка не нужна
            </label>
          </div>

          <div class="field" id="cardTextField">
            <label>текст для открытки</label>
            <textarea id="cardText" placeholder="например: с днём рождения!"></textarea>
          </div>

          <div class="field">
            <label>комментарий (необязательно)</label>
            <textarea id="comment" placeholder="например: код домофона, пожелания по ленте"></textarea>
          </div>
        </div>

        <div class="summary" id="summary"></div>

        <div class="sectionTitle">персональные данные</div>
        <div class="field">
          <label style="display:flex; align-items:flex-start; gap:10px; line-height:1.35;">
            <input id="pdConsent" type="checkbox" />
            <span>
              даю согласие на обработку персональных данных и принимаю
              <a href="#" id="openPrivacy" style="color:var(--wine); text-decoration:underline;">политику конфиденциальности</a>
            </span>
          </label>
        </div>


        <button class="btn primary" id="submitOrder" style="width:100%; margin-top:12px; padding:14px 12px; border-radius:18px;">
          отправить заказ
        </button>

        <div class="hint">
          оплата: после подтверждения заказа мы пришлём ссылку на оплату
        </div>
      </div>
    </div>
  </div>

  <!-- UX overlay -->
  <div class="uxOverlay" id="uxOverlay" aria-hidden="true">
    <div class="uxCard">
      <div class="uxCardHeader">
        <div class="t" id="uxTitle">сообщение</div>
        <button class="iconBtn" id="uxCloseBtn">✕</button>
      </div>
      <div class="uxCardBody">
        <p class="uxText" id="uxText"></p>
      </div>
      <div class="uxActions" id="uxActions"></div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  
  // бонусы
  const WELCOME_BONUS = 500; // начисляется на стороне backend один раз для нового tg_user_id
  let bonusBalance = null;   // число или null (если не определили пользователя)
  let maxBonusSpend = 0;
const API_BASE = "https://script.google.com/macros/s/AKfycbzdOFj8B64mrN1q_cmdhjOkvG4KsgZZP-6b2lpfdXBQ2-JUz3juEYcr76iPrvp5lGEhbA/exec";

  // поддержка
  const SUPPORT_USERNAME = "chaiori";
  const SUPPORT_URL = `https://t.me/${SUPPORT_USERNAME}`;

  // фиксированные слоты на будущие дни
  const TIME_SLOTS = ["10:00-14:00","14:00-18:00","18:00-22:00"];

  // динамика на сегодня: +3 часа, округление до 30 минут
  const DYNAMIC_LEAD_MINUTES = 180;
  const SLOT_STEP_MINUTES = 30;

  // РАБОЧЕЕ ВРЕМЯ ДОСТАВКИ
  const WORK_START_MINUTES = 10*60; // 10:00
  const WORK_END_MINUTES   = 22*60; // 22:00

  const DELIVERY_MKAD = 650;

  // localStorage
  const LS_CART = "dc_cart_v1";
  const LS_FORM = "dc_form_v1";
  const LS_PRODUCTS_CACHE = "dc_products_v1";

  // ====== STATE ======
  let products = [];
  let productsById = new Map();
  let categories = [];
  let activeCategory = "all";

  // cart: Map<id, qty>
  let cart = new Map();

  let currentProductId = null;
  let galleryIndex = 0;

  // perf caches
  let _cartCount = 0;
  let _cartSubtotal = 0;

  // ====== HELPERS ======
  
  function getTelegramContext(){
    try{
      const tg = window.Telegram?.WebApp;
      if (!tg) return { user:null, initData:"" };
      const user = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
      return { user, initData: tg.initData || "" };
    } catch(_) {
      return { user:null, initData:"" };
    }
  }
const fmt = (n) => new Intl.NumberFormat("ru-RU").format(Number(n) || 0) + " ₽";
  const el = (id) => document.getElementById(id);

  function todayISO(){
    const d = new Date();
    const tz = new Date(d.getTime() - d.getTimezoneOffset()*60000);
    return tz.toISOString().slice(0,10);
  }

  function minutesNow(){
    const d = new Date();
    return d.getHours()*60 + d.getMinutes();
  }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function toHM(min){
    const h = Math.floor(min/60);
    const m = min%60;
    return `${pad2(h)}:${pad2(m)}`;
  }
  function ceilToStep(min, step){
    return Math.ceil(min/step)*step;
  }

  function safeJsonParse(text){
    try { return JSON.parse(text); } catch(_) { return null; }
  }

  function nonEmptyPhotos(arr){
    return (Array.isArray(arr) ? arr : []).map(x => String(x || "").trim()).filter(Boolean);
  }

  // ===== стабилизация высоты webapp =====
  function setAppHeight(){
    const tg = window.Telegram?.WebApp;
    const h = (tg && tg.viewportHeight) ? tg.viewportHeight : window.innerHeight;
    document.documentElement.style.setProperty("--app-h", h + "px");
  }

  // ===== UX overlay =====
  function closeUX(){ el("uxOverlay").classList.remove("open"); }

  function openSupport(){
    try{
      const tg = window.Telegram?.WebApp;
      if (tg && typeof tg.openTelegramLink === "function"){
        tg.openTelegramLink(SUPPORT_URL);
        return;
      }
    } catch(_) {}
    window.open(SUPPORT_URL, "_blank");
  }

  function showUX({ title, text, actions = [] }){
    el("uxTitle").textContent = (title || "сообщение").toLowerCase();
    el("uxText").textContent = (text || "").toLowerCase();

    const a = el("uxActions");
    a.innerHTML = "";

    actions.forEach(btn => {
      const b = document.createElement("button");
      b.className = "btn " + (btn.kind === "secondary" ? "secondary" : "primary");
      b.textContent = (btn.text || "").toLowerCase();
      b.addEventListener("click", () => {
        if (btn.close !== false) closeUX();
        if (typeof btn.onClick === "function") btn.onClick();
      });
      a.appendChild(b);
    });

    if (actions.length === 0){
      const b = document.createElement("button");
      b.className = "btn primary";
      b.textContent = "ок";
      b.addEventListener("click", closeUX);
      a.appendChild(b);
    }

    el("uxOverlay").classList.add("open");
  }

  function showErrorUX(message){
    showUX({
      title: "не удалось",
      text: message || "не удалось отправить заказ. попробуй ещё раз или напиши нам в поддержку.",
      actions: [
        { text: "попробовать ещё раз", kind: "primary", onClick: ()=>{} },
        { text: "написать в поддержку", kind: "secondary", close: true, onClick: openSupport }
      ]
    });
  }

  function shortOrderCode(orderId){
    const digits = String(orderId || "").replace(/\D/g, "");
    if (digits.length >= 4) return digits.slice(-4);
    return (String(orderId || "").slice(-4) || "—");
  }

  function showSuccessUX(orderId){
    const code4 = shortOrderCode(orderId);
    const txt =
      `заказ отправлен.\nномер: ${code4}.\nмы свяжемся для подтверждения и оплаты.`;

    showUX({
      title: "готово",
      text: txt,
      actions: [
        { text: "вернуться в каталог", kind: "primary", onClick: ()=>{} }
      ]
    });
  }

  // ===== GOOGLE DRIVE IMAGE =====
  function extractDriveId(s){
    if (!s) return null;
    const str = String(s);

    let m = str.match(/drive\.google\.com\/file\/d\/([^/]+)\//);
    if (m && m[1]) return m[1];

    m = str.match(/[?&]id=([^&]+)/);
    if (m && m[1]) return m[1];

    m = str.match(/drive\.google\.com\/open\?id=([^&]+)/);
    if (m && m[1]) return m[1];

    return null;
  }

  function driveCandidates(url){
    if (!url) return [];
    const id = extractDriveId(url);
    if (!id) return [String(url)];

    return [
      `https://drive.google.com/thumbnail?id=${id}&sz=w2000`,
      `https://drive.google.com/uc?export=view&id=${id}`,
      `https://drive.google.com/uc?export=download&id=${id}`
    ];
  }

  function setImgWithFallback(imgEl, url){
    const list = driveCandidates(url);
    if (list.length === 0){
      imgEl.removeAttribute("src");
      return;
    }
    let idx = 0;
    imgEl.onerror = () => {
      idx += 1;
      if (idx < list.length){
        imgEl.src = list[idx];
      } else {
        imgEl.onerror = null;
        imgEl.removeAttribute("src");
      }
    };
    imgEl.src = list[0];
  }

  // СЛОТЫ: только 10:00–22:00; ночью начинаем от 10:00
  function availableSlotsForDate(dateISO){
    if (dateISO !== todayISO()) return TIME_SLOTS.slice();

    const now = minutesNow();

    const start = Math.max(
      WORK_START_MINUTES,
      ceilToStep(now + DYNAMIC_LEAD_MINUTES, SLOT_STEP_MINUTES)
    );

    if (start >= WORK_END_MINUTES) return [];

    const slots = [];
    for (let t = start; t < WORK_END_MINUTES; t += SLOT_STEP_MINUTES){
      const end = Math.min(t + TODAY_WINDOW_MINUTES, WORK_END_MINUTES);
      if ((end - t) < 60) continue;
      slots.push(`${toHM(t)}-${toHM(end)}`);
    }
    return slots;
  }

  // ===== CART FAST =====
  function recomputeCartCaches(){
    let count = 0;
    let sum = 0;
    for (const [id, qty] of cart.entries()){
      count += qty;
      const p = productsById.get(String(id));
      if (p) sum += (Number(p.price) || 0) * qty;
    }
    _cartCount = count;
    _cartSubtotal = sum;
  }
  function cartCount(){ return _cartCount; }
  function cartSubtotal(){ return _cartSubtotal; }

  function getCartItemsArray(){
    const out = [];
    for (const [id, qty] of cart.entries()){
      const p = productsById.get(String(id));
      if (p) out.push({ ...p, qty });
    }
    return out;
  }

  function saveCart(){
    try{
      const obj = {};
      for (const [id, qty] of cart.entries()) obj[id] = qty;
      localStorage.setItem(LS_CART, JSON.stringify(obj));
    } catch(_) {}
  }

  function loadCart(){
    try{
      const raw = localStorage.getItem(LS_CART);
      const obj = raw ? safeJsonParse(raw) : null;
      if (!obj || typeof obj !== "object") return;
      const m = new Map();
      for (const k of Object.keys(obj)){
        const q = Number(obj[k]) || 0;
        if (q > 0) m.set(String(k), q);
      }
      cart = m;
    } catch(_) {}
  }

  function updateCheckoutButtons(){
    const hasItems = cartCount() > 0;
    el("checkoutBtn").disabled = !hasItems;
    el("goCheckoutFromProduct").disabled = !hasItems;
  }

  function updateBottom(){
    const count = cartCount();
    el("cartCount").textContent = count;
    el("bottomCount").textContent = count;
    el("bottomTotal").textContent = fmt(cartSubtotal());
    el("bottomBar").style.display = count > 0 ? "block" : "none";
  }

  function setQty(id, qty){
    const key = String(id);
    if (qty <= 0) cart.delete(key);
    else cart.set(key, qty);

    recomputeCartCaches();
    saveCart();

    updateBonusConstraints();
    renderGrid();
    updateBottom();
    updateCheckoutButtons();

    if (currentProductId && String(currentProductId) === key) {
      renderProductControls();
    }
  }

  function deliveryCost(){
    const t = el("deliveryType").value;
    if (t === "mkad") return DELIVERY_MKAD;
    if (t === "pickup") return 0;
    return null;
  }

  // ===== FILTERS =====
  function getCategory(p){
    const raw = (p.category ?? p.wrap ?? "").toString().trim();
    return raw ? raw : "без категории";
  }

  function renderFilters(){
    const root = el("filters");
    if (!categories || categories.length <= 1){
      root.style.display = "none";
      return;
    }

    root.style.display = "flex";
    root.innerHTML = "";

    const frag = document.createDocumentFragment();

    const allChip = document.createElement("button");
    allChip.className = "chip" + (activeCategory === "all" ? " on" : "");
    allChip.textContent = "все";
    allChip.onclick = () => { activeCategory = "all"; renderFilters(); renderGrid(); };
    frag.appendChild(allChip);

    categories.forEach(c => {
      const chip = document.createElement("button");
      chip.className = "chip" + (activeCategory === c ? " on" : "");
      chip.textContent = c.toLowerCase();
      chip.onclick = () => { activeCategory = c; renderFilters(); renderGrid(); };
      frag.appendChild(chip);
    });

    root.appendChild(frag);
  }

  // ====== UI: GRID ======
  function renderGrid(){
    const grid = el("grid");
    grid.innerHTML = "";

    if (!Array.isArray(products) || products.length === 0){
      grid.innerHTML = `
        <div style="grid-column:1/-1; padding:14px; border:1px solid var(--stroke); border-radius:var(--radius); background:#fff; color:var(--muted); font-weight:400; text-transform:lowercase;">
          товаров пока нет
        </div>
      `;
      return;
    }

    const shown = (activeCategory === "all")
      ? products
      : products.filter(p => getCategory(p) === activeCategory);

    if (shown.length === 0){
      grid.innerHTML = `
        <div style="grid-column:1/-1; padding:14px; border:1px solid var(--stroke); border-radius:var(--radius); background:#fff; color:var(--muted); font-weight:400; text-transform:lowercase;">
          в этой категории пока нет товаров
        </div>
      `;
      return;
    }

    const frag = document.createDocumentFragment();

    shown.forEach(p => {
      const id = String(p.id);
      const card = document.createElement("div");
      card.className = "card";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      thumb.dataset.open = id;

      const img = document.createElement("img");
      img.alt = p.name || "";
      img.loading = "lazy";
      img.decoding = "async";
      const photos = nonEmptyPhotos(p.photos);
      if (photos[0]) setImgWithFallback(img, photos[0]);
      thumb.appendChild(img);

      const content = document.createElement("div");
      content.className = "content";

      const title = document.createElement("p");
      title.className = "title";
      title.textContent = (p.name || "").toLowerCase();

      const row = document.createElement("div");
      row.className = "row";

      const price = document.createElement("p");
      price.className = "price";
      price.textContent = fmt(p.price);

      const controls = document.createElement("div");
      const qty = cart.get(id) || 0;

      if (qty <= 0){
        const btn = document.createElement("button");
        btn.className = "btn primary";
        btn.textContent = "в корзину";
        btn.dataset.add = id;
        controls.appendChild(btn);
      } else {
        const box = document.createElement("div");
        box.className = "qty";

        const minus = document.createElement("button");
        minus.textContent = "–";
        minus.dataset.dec = id;

        const n = document.createElement("span");
        n.textContent = qty;

        const plus = document.createElement("button");
        plus.textContent = "+";
        plus.dataset.inc = id;

        box.append(minus, n, plus);
        controls.appendChild(box);
      }

      row.append(price, controls);
      content.append(title, row);

      card.append(thumb, content);
      frag.appendChild(card);
    });

    grid.appendChild(frag);
  }

  function onGridClick(e){
    const t = e.target;

    const add = t?.dataset?.add;
    const inc = t?.dataset?.inc;
    const dec = t?.dataset?.dec;

    if (add){
      e.stopPropagation();
      setQty(add, 1);
      return;
    }
    if (inc){
      e.stopPropagation();
      setQty(inc, (cart.get(String(inc)) || 0) + 1);
      return;
    }
    if (dec){
      e.stopPropagation();
      const cur = cart.get(String(dec)) || 0;
      setQty(dec, cur - 1);
      return;
    }

    const openId = t?.closest?.("[data-open]")?.dataset?.open;
    if (openId){
      openProduct(openId);
      return;
    }
  }

  // ====== UI: PRODUCT MODAL ======
  function openProduct(id){
    const p = productsById.get(String(id));
    if (!p) return;

    currentProductId = String(id);
    galleryIndex = 0;

    el("pTitle").textContent = (p.name || "товар").toLowerCase();
    el("pDesc").textContent = p.description || "";
    el("pPrice").textContent = fmt(p.price);

    renderGallery();
    renderProductControls();

    el("productOverlay").classList.add("open");
    updateCheckoutButtons();
  }

  function closeProduct(){
    el("productOverlay").classList.remove("open");
    currentProductId = null;
  }

  function renderGallery(){
    const p = productsById.get(String(currentProductId));
    const photos = nonEmptyPhotos(p?.photos);
    const img = el("gImg");

    if (!photos.length){
      img.removeAttribute("src");
    } else {
      setImgWithFallback(img, photos[galleryIndex] || photos[0]);
    }

    const dots = el("dots");
    dots.innerHTML = "";
    photos.forEach((_, i) => {
      const d = document.createElement("div");
      d.className = "dot" + (i === galleryIndex ? " on" : "");
      d.addEventListener("click", () => { galleryIndex = i; renderGallery(); });
      dots.appendChild(d);
    });

    const gallery = el("gallery");
    if (!gallery.dataset.swipeBound){
      gallery.dataset.swipeBound = "1";
      let startX = null;
      gallery.addEventListener("touchstart", (ev)=>{ startX = ev.touches[0].clientX; }, { passive:true });
      gallery.addEventListener("touchend", (ev)=>{
        if (startX === null) return;
        const endX = ev.changedTouches[0].clientX;
        const dx = endX - startX;
        startX = null;

        if (Math.abs(dx) < 40) return;
        const p2 = productsById.get(String(currentProductId));
        const ph = nonEmptyPhotos(p2?.photos);
        const len = ph.length;
        if (!len) return;

        if (dx < 0) galleryIndex = Math.min(len-1, galleryIndex+1);
        else galleryIndex = Math.max(0, galleryIndex-1);

        renderGallery();
      }, { passive:true });
    }
  }

  function renderProductControls(){
    const p = productsById.get(String(currentProductId));
    const box = el("pControls");
    box.innerHTML = "";
    if (!p) return;

    const id = String(p.id);
    const qty = cart.get(id) || 0;

    if (qty <= 0){
      const btn = document.createElement("button");
      btn.className = "btn primary";
      btn.textContent = "в корзину";
      btn.addEventListener("click", () => {
        setQty(id, 1);
        updateCheckoutButtons();
      });
      box.appendChild(btn);
    } else {
      const q = document.createElement("div");
      q.className = "qty";

      const minus = document.createElement("button");
      minus.textContent = "–";
      minus.addEventListener("click", () => { setQty(id, qty-1); updateCheckoutButtons(); });

      const n = document.createElement("span");
      n.textContent = qty;

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.addEventListener("click", () => { setQty(id, qty+1); updateCheckoutButtons(); });

      q.append(minus, n, plus);
      box.appendChild(q);
    }
  }

  // ====== CART / CHECKOUT ======
  function openCart(){
    renderCart();
    el("cartOverlay").classList.add("open");
    updateCheckoutButtons();
  }
  function closeCart(){
    el("cartOverlay").classList.remove("open");
  }

  function renderCart(){
    const items = getCartItemsArray();
    const root = el("cartItems");
    root.innerHTML = "";

    if (items.length === 0){
      root.innerHTML = `<div style="color:var(--muted);font-size:13px;font-weight:400;text-transform:lowercase;">корзина пустая</div>`;
      el("summary").innerHTML = "";
      return;
    }

    const frag = document.createDocumentFragment();

    items.forEach(it => {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.gap = "10px";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.padding = "10px 0";
      row.style.borderBottom = "1px solid var(--stroke)";

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";
      left.style.gap = "4px";

      const nm = document.createElement("div");
      nm.style.fontWeight = "600";
      nm.style.fontSize = "13px";
      nm.style.textTransform = "lowercase";
      nm.style.color = "var(--wine)";
      nm.textContent = (it.name || "").toLowerCase();

      const pr = document.createElement("div");
      pr.style.color = "var(--muted)";
      pr.style.fontSize = "12px";
      pr.style.fontWeight = "400";
      pr.style.textTransform = "lowercase";
      pr.textContent = `${fmt(it.price)} × ${it.qty}`;

      left.append(nm, pr);

      const q = document.createElement("div");
      q.className = "qty";

      const minus = document.createElement("button");
      minus.textContent = "–";
      minus.addEventListener("click", () => { setQty(it.id, it.qty-1); renderCart(); });

      const n = document.createElement("span");
      n.textContent = it.qty;

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.addEventListener("click", () => { setQty(it.id, it.qty+1); renderCart(); });

      q.append(minus, n, plus);

      row.append(left, q);
      frag.appendChild(row);
    });

    root.appendChild(frag);
    renderSummary();
  }

  function renderTimeSlots(){
    const dateISO = el("date").value || todayISO();
    const slots = availableSlotsForDate(dateISO);

    const select = el("timeSlot");
    select.innerHTML = "";

    if (slots.length === 0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "на выбранную дату слотов нет";
      select.appendChild(opt);
      select.disabled = true;
      return;
    }

    select.disabled = false;
    slots.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      select.appendChild(opt);
    });
  }

  function renderSummary(){
    const sub = cartSubtotal();
    const dType = el("deliveryType").value;
    const dCost = deliveryCost();
    const rawBonus = Number(el("bonusToSpend")?.value || 0) || 0;
    const allowed = Math.max(0, Math.min(rawBonus, maxBonusSpend || 0));
    if (el("bonusToSpend") && allowed !== rawBonus) el("bonusToSpend").value = allowed ? String(allowed) : "";


    const lines = [];
    lines.push(`<div class="line"><span>товары</span><span>${fmt(sub)}</span></div>`);

    if (dType === "mkad"){
      lines.push(`<div class="line"><span>доставка</span><span>${fmt(dCost)}</span></div>`);
      if (allowed > 0) lines.push(`<div class="line"><span>бонусы</span><span>- ${fmt(allowed)}</span></div>`);
      lines.push(`<div class="line total"><span>итого</span><span>${fmt(sub + dCost - allowed)}</span></div>`);
    } else if (dType === "pickup"){
      lines.push(`<div class="line"><span>самовывоз</span><span>${fmt(0)}</span></div>`);
      lines.push(`<div class="line"><span>адрес</span><span>Автозаводская 23с2</span></div>`);
      if (allowed > 0) lines.push(`<div class="line"><span>бонусы</span><span>- ${fmt(allowed)}</span></div>`);
      lines.push(`<div class="line total"><span>итого</span><span>${fmt(sub - allowed)}</span></div>`);
    } else {
      lines.push(`<div class="line"><span>доставка</span><span>уточним</span></div>`);
      if (allowed > 0) lines.push(`<div class="line"><span>бонусы</span><span>- ${fmt(allowed)}</span></div>`);
      lines.push(`<div class="line total"><span>итого</span><span>${fmt(sub - allowed)}</span></div>`);
    }

    el("summary").innerHTML = lines.join("");
  }

  // ===== PHONE MASK + VALIDATION =====
  function onlyDigits(s){ return String(s || "").replace(/\D/g, ""); }

  function formatPhoneRU(value){
    let d = onlyDigits(value);
    if (d.startsWith("8")) d = "7" + d.slice(1);
    if (d.length && !d.startsWith("7")) d = "7" + d;
    d = d.slice(0, 11);

    const p = d.slice(1);
    const a = p.slice(0,3);
    const b = p.slice(3,6);
    const c = p.slice(6,8);
    const e = p.slice(8,10);

    let out = "+7";
    if (a) out += " (" + a;
    if (a.length === 3) out += ")";
    if (b) out += " " + b;
    if (c) out += "-" + c;
    if (e) out += "-" + e;
    return out;
  }

  function normalizePhoneRU(value){
    let d = onlyDigits(value);
    if (d.startsWith("8")) d = "7" + d.slice(1);
    if (d.length && !d.startsWith("7")) d = "7" + d;
    return d.slice(0, 11);
  }

  function isValidPhoneRU(value){
    const d = normalizePhoneRU(value);
    return d.length === 11 && d.startsWith("7");
  }

  function attachPhoneMask(inputId){
    const inp = el(inputId);
    inp.addEventListener("input", () => {
      const caretAtEnd = inp.selectionStart === inp.value.length;
      inp.value = formatPhoneRU(inp.value);
      if (caretAtEnd) inp.setSelectionRange(inp.value.length, inp.value.length);
    });
  }

  function syncRecipientIfSame(){
    if (!el("sameAsCustomer").checked) return;
    el("recipientName").value = el("customerName").value.trim();
    el("recipientPhone").value = el("customerPhone").value.trim();
  }

  function saveFormDraft(){
    try{
      const obj = {
        deliveryType: el("deliveryType").value,
        date: el("date").value,
        timeSlot: el("timeSlot").value,
        address: el("address").value,
        customerName: el("customerName").value,
        customerPhone: el("customerPhone").value,
        sameAsCustomer: el("sameAsCustomer").checked,
        recipientName: el("recipientName").value,
        recipientPhone: el("recipientPhone").value,
        cardNotNeeded: el("cardNotNeeded").checked,
        cardText: el("cardText").value,
        comment: el("comment").value,
        pdConsent: el("pdConsent").checked,
        clarifyAddressWithRecipient: el("clarifyAddressWithRecipient").checked,
                bonusToSpend: el("bonusToSpend").value
      };
      localStorage.setItem(LS_FORM, JSON.stringify(obj));
    } catch(_) {}
  }

  function loadFormDraft(){
    try{
      const raw = localStorage.getItem(LS_FORM);
      const obj = raw ? safeJsonParse(raw) : null;
      if (!obj) return;

      if (obj.deliveryType) el("deliveryType").value = obj.deliveryType;
      if (obj.date) el("date").value = obj.date;
      if (obj.address != null) el("address").value = obj.address;

      if (obj.customerName != null) el("customerName").value = obj.customerName;
      if (obj.customerPhone != null) el("customerPhone").value = obj.customerPhone;

      el("sameAsCustomer").checked = !!obj.sameAsCustomer;
      if (obj.recipientName != null) el("recipientName").value = obj.recipientName;
      if (obj.recipientPhone != null) el("recipientPhone").value = obj.recipientPhone;

      el("cardNotNeeded").checked = !!obj.cardNotNeeded;
      if (obj.cardText != null) el("cardText").value = obj.cardText;
      if (obj.comment != null) el("comment").value = obj.comment;
      el("pdConsent").checked = !!obj.pdConsent;
      el("clarifyAddressWithRecipient").checked = !!obj.clarifyAddressWithRecipient;
            if (obj.bonusToSpend != null) el("bonusToSpend").value = obj.bonusToSpend;
    } catch(_) {}
  }

  function setSubmitLoading(isLoading){
    const btn = el("submitOrder");
    if (!btn) return;

    if (isLoading){
      btn.disabled = true;
      btn.dataset.prev = btn.textContent;
      btn.innerHTML = `<span class="spinner"></span> отправляем…`;
    } else {
      btn.disabled = false;
      btn.textContent = btn.dataset.prev || "отправить заказ";
      btn.dataset.prev = "";
    }
  }

  async function submitOrder(){
    const items = getCartItemsArray();
    if (items.length === 0){
      showUX({ title:"корзина пустая", text:"добавь товары и попробуй ещё раз." });
      return;
    }

    const customer_name = el("customerName").value.trim();
    const customer_phone = el("customerPhone").value.trim();

    const delivery_type = el("deliveryType").value;

    const address = el("address").value.trim();
    const date = el("date").value;
    const time_slot = el("timeSlot").value;

    const same = el("sameAsCustomer").checked;
    const recipient_name = same ? customer_name : el("recipientName").value.trim();
    const recipient_phone = same ? customer_phone : el("recipientPhone").value.trim();

    if (!el("pdConsent").checked){
      showUX({ title:"согласие", text:"перед отправкой заказа нужно согласие на обработку персональных данных." });
      return;
    }

    if (!customer_name || !customer_phone || !recipient_name || !recipient_phone || !date || !time_slot){
      showUX({ title:"проверь поля", text:"нужны: заказчик, получатель, дата и интервал." });
      return;
    }

    if (!isValidPhoneRU(customer_phone)){
      showUX({ title:"телефон", text:"проверь телефон заказчика: нужен полный номер рф (+7…)." });
      return;
    }
    if (!isValidPhoneRU(recipient_phone)){
      showUX({ title:"телефон", text:"проверь телефон получателя: нужен полный номер рф (+7…)." });
      return;
    }

    const slots = availableSlotsForDate(date);
    if (!slots.includes(time_slot)){
      renderTimeSlots();
      showUX({ title:"интервал", text:"этот интервал уже недоступен. выбери другой." });
      return;
    }

    const delivery_price = (delivery_type === "mkad") ? DELIVERY_MKAD : (delivery_type === "pickup" ? 0 : "уточним");

    let finalAddress = address;
    if (delivery_type === "pickup"){
      finalAddress = "Самовывоз: Автозаводская 23с2";
    }

    const card_not_needed = el("cardNotNeeded").checked;
    const card_text = card_not_needed ? "" : (el("cardText").value || "").trim();

    const clarify_address_with_recipient = !!el("clarifyAddressWithRecipient").checked;
    const bonus_to_spend = Number(el("bonusToSpend")?.value || 0) || 0;

    const payload = {
      action: "create_order",

      // telegram context
      tg_user_id: 0,
      tg_init_data: "",
      tg_username: "",
      tg_first_name: "",
      tg_last_name: "",

      customer_name,
      customer_phone: normalizePhoneRU(customer_phone),

      recipient_name,
      recipient_phone: normalizePhoneRU(recipient_phone),
      same_as_customer: same,

      address: finalAddress,
      date,
      time_slot,
      delivery_type,
      delivery_price,
      total: (delivery_type === "mkad") ? (cartSubtotal() + DELIVERY_MKAD) : cartSubtotal(),
      subtotal: cartSubtotal(),
      bonus_to_spend_allowed: Math.max(0, Math.min(bonus_to_spend, maxBonusSpend || 0)),
      items: items.map(it => ({ id: it.id, name: it.name, qty: it.qty, price: it.price })),

      card_not_needed,
      card_text,
      comment: (el("comment").value || "").trim(),

      clarify_address_with_recipient,      bonus_to_spend,
      pd_consent: true
    };

    // Telegram WebApp context
    try{
      const tg = window.Telegram?.WebApp;
      if (tg){
        tg.ready();
        tg.expand?.();
        const u = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
        if (tg.initData) payload.tg_init_data = tg.initData;
        if (u){
          payload.tg_user_id = u.id || 0;
          payload.tg_init_data = tg.initData || "";
          payload.tg_username = u.username || "";
          payload.tg_first_name = u.first_name || "";
          payload.tg_last_name = u.last_name || "";
        }
      }
    } catch(_) {}

    setSubmitLoading(true);

    try{
      // ВАЖНО: text/plain -> без preflight, стабильнее для GAS
      const res = await fetch(API_BASE, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      const raw = await res.text();
      const json = safeJsonParse(raw);

      if (!res.ok){
        throw new Error(json?.error || raw || `http ${res.status}`);
      }
      if (json && json.status === "error"){
        throw new Error(json.error || "ошибка сервера");
      }

      const orderId = json?.order_id || "";

      cart = new Map();
      recomputeCartCaches();
      saveCart();

      updateBottom();
      renderGrid();
      closeCart();
      closeProduct();

      showSuccessUX(orderId);
    } catch(err){
      console.error(err);
      showErrorUX("не удалось отправить заказ. попробуй ещё раз или напиши нам в поддержку.");
    } finally{
      setSubmitLoading(false);
    }
  }

  // ====== PRODUCTS LOADING + CACHE ======
  function saveProductsCache(arr){
    try{
      const pack = { ts: Date.now(), products: arr };
      localStorage.setItem(LS_PRODUCTS_CACHE, JSON.stringify(pack));
    } catch(_) {}
  }

  function loadProductsCache(maxAgeMs){
    try{
      const raw = localStorage.getItem(LS_PRODUCTS_CACHE);
      const pack = raw ? safeJsonParse(raw) : null;
      if (!pack || !pack.ts || !Array.isArray(pack.products)) return null;
      if ((Date.now() - pack.ts) > maxAgeMs) return null;
      return pack.products;
    } catch(_) { return null; }
  }

  async function loadProducts(){
    // быстрый старт: кэш на 10 минут
    const cached = loadProductsCache(10 * 60 * 1000);
    if (cached){
      applyProducts(cached);
      return;
    }

    const url = `${API_BASE}?action=products`;
    const res = await fetch(url, { method:"GET", cache:"no-store" });
    if (!res.ok) throw new Error(`GET products: HTTP ${res.status}`);

    const json = await res.json();
    const arr = Array.isArray(json) ? json : (json && Array.isArray(json.products) ? json.products : []);
    applyProducts(arr);
    saveProductsCache(arr);
  }

  function applyProducts(arr){
    products = arr.map((p, i) => ({
      id: (p.id ?? p.sku ?? p.code ?? i).toString(),
      name: p.name ?? p.title ?? "без названия",
      price: Number(p.price ?? p.cost ?? 0) || 0,
      description: p.description ?? p.desc ?? "",
      photos: nonEmptyPhotos(Array.isArray(p.photos) ? p.photos : (Array.isArray(p.images) ? p.images : [])),
      category: (p.category ?? p.wrap ?? "").toString().trim(),
      wrap: (p.wrap ?? "").toString().trim()
    }));

    productsById = new Map();
    products.forEach(p => productsById.set(String(p.id), p));

    categories = Array.from(new Set(products.map(getCategory))).filter(Boolean);
  }

  // ====== INIT ======
  
  const PRIVACY_TEXT =
`политика конфиденциальности
мы обрабатываем только данные, необходимые для оформления и исполнения заказа: имя, телефон, адрес доставки, комментарии к заказу, а также технические идентификаторы telegram (id/username), если они доступны.
данные используются для связи, подтверждения заказа, организации доставки и бухгалтерского учёта.
мы не продаём и не передаём персональные данные третьим лицам, кроме случаев, когда это необходимо для исполнения заказа (например, курьерской службе).
срок хранения: до достижения целей обработки и в пределах, установленных законом.
контакты для вопросов: @chaiori (9:00–21:00 мск).`;
function initForm(){
    el("date").value = todayISO();
    loadFormDraft();

    renderTimeSlots();

    // keep selection if possible
    const desired = el("timeSlot").value;
    if (desired){
      const options = Array.from(el("timeSlot").options).map(o => o.value);
      if (!options.includes(desired)) el("timeSlot").selectedIndex = 0;
    }

    el("date").addEventListener("change", () => {
      renderTimeSlots();
      saveFormDraft();
    });

    el("deliveryType").addEventListener("change", () => {
      const t = el("deliveryType").value;

      if (t === "pickup"){
        el("address").value = "";
        el("address").disabled = true;
        el("address").placeholder = "пример: самовывоз — Автозаводская 23с2";
      } else {
        el("address").disabled = false;
        el("address").placeholder = "пример: город, улица, дом, подъезд, квартира";
      }

      updateBonusConstraints();
      renderSummary();
      saveFormDraft();
    });

    el("sameAsCustomer").addEventListener("change", () => {
      const same = el("sameAsCustomer").checked;
      el("recipientFields").style.display = same ? "none" : "grid";
      if (same) syncRecipientIfSame();
      saveFormDraft();
    });

    el("customerName").addEventListener("input", () => { syncRecipientIfSame(); saveFormDraft(); });
    el("customerPhone").addEventListener("input", () => { syncRecipientIfSame(); saveFormDraft(); });

    el("recipientName").addEventListener("input", saveFormDraft);
    el("recipientPhone").addEventListener("input", saveFormDraft);
    el("address").addEventListener("input", saveFormDraft);
    el("timeSlot").addEventListener("change", () => { updateBonusConstraints(); renderSummary(); saveFormDraft(); });

    el("bonusToSpend").addEventListener("input", () => { updateBonusConstraints(); renderSummary(); saveFormDraft(); });

    el("cardNotNeeded").addEventListener("change", () => {
      const off = el("cardNotNeeded").checked;
      el("cardTextField").style.display = off ? "none" : "flex";
      if (off) el("cardText").value = "";
      saveFormDraft();
    });

    el("cardText").addEventListener("input", saveFormDraft);
    el("comment").addEventListener("input", saveFormDraft);

    attachPhoneMask("customerPhone");
    attachPhoneMask("recipientPhone");

    const same = el("sameAsCustomer").checked;
    el("recipientFields").style.display = same ? "none" : "grid";

    const off = el("cardNotNeeded").checked;
    el("cardTextField").style.display = off ? "none" : "flex";

    renderSummary();
  }

  function initUI(){
    el("openCartBtn").addEventListener("click", openCart);
    el("checkoutBtn").addEventListener("click", openCart);

    el("closeCart").addEventListener("click", closeCart);
    el("closeProduct").addEventListener("click", closeProduct);

    el("cartOverlay").addEventListener("click", (e) => {
      if (e.target === el("cartOverlay")) closeCart();
    });
    el("productOverlay").addEventListener("click", (e) => {
      if (e.target === el("productOverlay")) closeProduct();
    });

    el("goCheckoutFromProduct").addEventListener("click", () => {
      if (cartCount() <= 0) return;
      closeProduct();
      openCart();
    });

    el("submitOrder").addEventListener("click", submitOrder);

    el("openPrivacy").addEventListener("click", (e)=>{
      e.preventDefault();
      showUX({ title: "политика", text: PRIVACY_TEXT, actions: [{ text: "закрыть", kind: "primary" }] });
    });

    el("uxCloseBtn").addEventListener("click", closeUX);
    el("uxOverlay").addEventListener("click", (e) => {
      if (e.target === el("uxOverlay")) closeUX();
    });

    el("grid").addEventListener("click", onGridClick);
  }

  async function boot(){
    
  async function loadBonusBalance(){
    const ctx = getTelegramContext();
    const uid = ctx.user && ctx.user.id ? Number(ctx.user.id) : 0;
    if (!uid && !ctx.initData){
      bonusBalance = null;
      updateBonusConstraints();
      return;
    }

    try{
      const payload = {
        action: "get_bonus",
        tg_user_id: uid || 0,
        tg_init_data: ctx.initData || ""
      };

      const res = await fetch(API_BASE, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      const raw = await res.text();
      const json = safeJsonParse(raw);

      if (!res.ok) throw new Error(raw || `http ${res.status}`);
      if (json && json.status === "ok"){
        bonusBalance = Number(json.balance) || 0;
      } else {
        bonusBalance = 0;
      }
    } catch(_){
      bonusBalance = 0;
    } finally{
      updateBonusConstraints();
      renderSummary();
    }
  }
initUI();

    try{
      const tg = window.Telegram?.WebApp;
      if (tg){
        tg.ready();
        tg.expand?.();
        setAppHeight();
        tg.onEvent?.("viewportChanged", setAppHeight);
        
      // тема telegram: синхронизация переменных и акцентов
      const applyTheme = () => {
        try{
          const tg2 = window.Telegram?.WebApp;
          const tp = tg2?.themeParams || {};
          const isDark = tg2?.colorScheme === "dark";
          document.documentElement.dataset.theme = isDark ? "dark" : "light";

          // базовые цвета берем из телеграма, но сохраняем винный бренд
          if (tp.bg_color) document.documentElement.style.setProperty("--tg-theme-bg-color", tp.bg_color);
          if (tp.text_color) document.documentElement.style.setProperty("--tg-theme-text-color", tp.text_color);
          if (tp.hint_color) document.documentElement.style.setProperty("--tg-theme-hint-color", tp.hint_color);
          if (tp.secondary_bg_color) document.documentElement.style.setProperty("--tg-theme-secondary-bg-color", tp.secondary_bg_color);

          // смягчаем "голубую дымку" в тёмной теме, чтобы не было выжженного оттенка
          if (isDark){
            document.documentElement.style.setProperty("--bgTint", "rgba(180,210,240,.10)");
            document.documentElement.style.setProperty("--glassBlue", "rgba(30,34,38,.70)");
            document.documentElement.style.setProperty("--glassBlueSoft", "rgba(30,34,38,.55)");
            document.documentElement.style.setProperty("--stroke", "rgba(255,255,255,.10)");
          } else {
            document.documentElement.style.setProperty("--bgTint", "rgba(207,232,255,.28)");
            document.documentElement.style.setProperty("--glassBlue", "rgba(207,232,255,.55)");
            document.documentElement.style.setProperty("--glassBlueSoft", "rgba(207,232,255,.35)");
            document.documentElement.style.setProperty("--stroke", "rgba(120,2,14,.10)");
          }
        } catch(_) {}
      };
      applyTheme();
      try{ window.Telegram?.WebApp?.onEvent?.("themeChanged", applyTheme); } catch(_) {}

      } else {
        setAppHeight();
      }
    } catch(_) {
      setAppHeight();
    }
    window.addEventListener("resize", setAppHeight);

    loadCart();
    recomputeCartCaches();
    updateBottom();
    updateCheckoutButtons();
    updateBonusConstraints();

    try{
      el("grid").innerHTML = `
        <div style="grid-column:1/-1; padding:14px; border:1px solid var(--stroke); border-radius:var(--radius); background:#fff; color:var(--muted); font-weight:400; text-transform:lowercase;">
          загружаем товары…
        </div>
      `;

      await loadProducts();
      try{ const db=el("debugBar"); db.style.display="block"; db.textContent = `товаров: ${products.length}`; }catch(_){}
      renderFilters();
      renderGrid();
      updateBottom();
      updateCheckoutButtons();

      initForm();

      await loadBonusBalance();
    } catch (err){
      console.error(err);
      el("grid").innerHTML = `
        <div style="grid-column:1/-1; padding:14px; border:1px solid var(--stroke); border-radius:var(--radius); background:#fff; color:var(--muted); font-weight:400; text-transform:lowercase;">
          не удалось загрузить каталог: <span style="color:var(--wine); font-weight:600;">${String(err?.message || "ошибка")}</span>
          <div style="margin-top:10px;">
            <button class="btn secondary" style="padding:10px 12px;" onclick="(${openSupport.toString()})()">написать в поддержку</button>
          </div>
        </div>
      `;
    }
  }

  document.addEventListener("DOMContentLoaded", boot);
</script>

</body>
</html>
